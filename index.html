<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Si-3.26 Auto-News Analysis</title>
    <style>
        * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: #1e1f2b; color: #e0e0e0; margin: 0; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { color: #b0b7ca; border-bottom: 1px solid #333; padding-bottom: 10px; }
        
        .api-section { background: #2a2c39; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .input-row { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
        .api-input { flex: 1; min-width: 150px; background: #1e1f2b; border: 1px solid #444; color: white; padding: 10px; border-radius: 6px; }
        
        button { background: #3a6ea5; border: none; color: white; padding: 10px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        button:hover { background: #4d7db8; }
        button:disabled { background: #555; cursor: not-allowed; }
        
        .chart-container { background: #2a2c39; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        #chart { width: 100%; height: 400px; }
        
        .status-msg { margin-top: 10px; font-size: 14px; padding: 10px; border-radius: 4px; display: none; }
        .error { background: #442326; color: #f28b82; display: block; }
        .success { background: #234427; color: #4caf50; display: block; }
        
        .indicators-panel { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .indicator-card { background: #2a2c39; padding: 15px; border-radius: 6px; border-left: 4px solid #5f9ea0; }
        .indicator-card h3 { margin: 0 0 5px 0; color: #b0b7ca; font-size: 14px; }
        .indicator-card .value { font-size: 20px; font-weight: 600; }
        
        pre { background: #2a2c39; padding: 15px; border-radius: 6px; white-space: pre-wrap; font-family: monospace; line-height: 1.5; }
        
        .news-box { background: #1e1f2b; padding: 10px; border-radius: 4px; margin-top: 10px; font-size: 12px; color: #aaa; border: 1px dashed #444; }
    </style>
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
</head>
<body>
    <div class="container">
        <h1>üìà Si-3.26 (SiH6) ‚Äî –ê–≤—Ç–æ-–∞–Ω–∞–ª–∏–∑</h1>

        <div class="api-section">
            <div class="input-row">
                <input type="text" id="moexUsername" class="api-input" placeholder="–õ–æ–≥–∏–Ω MOEX (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)">
                <input type="password" id="moexPassword" class="api-input" placeholder="–ü–∞—Ä–æ–ª—å MOEX">
            </div>
            <div class="input-row">
                <input type="date" id="fromDate" class="api-input">
                <input type="date" id="tillDate" class="api-input">
                <button id="loadDataBtn" style="flex: 0 0 auto;">üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
            </div>
            
            <div style="margin-top:15px; padding-top:15px; border-top:1px solid #444;">
                <div class="input-row">
                    <input type="password" id="deepseekApiKey" class="api-input" placeholder="DeepSeek API Key">
                </div>
                <button id="analyzeBtn" disabled style="width: 100%; background: #2e7d32;">üîç –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–≥–Ω–æ–∑ (–ê–≤—Ç–æ-–Ω–æ–≤–æ—Å—Ç–∏ + –ì—Ä–∞—Ñ–∏–∫)</button>
            </div>
            
            <div id="status" class="status-msg"></div>
            <div id="newsBox" class="news-box" style="display:none;"><b>üì∞ –ó–∞–≥–æ–ª–æ–≤–∫–∏ –Ω–æ–≤–æ—Å—Ç–µ–π:</b><br><span id="newsContent"></span></div>
        </div>

        <div class="indicators-panel" id="indicatorsPanel">
            <div class="indicator-card"><h3>–°—Ç–∞—Ç—É—Å</h3><div class="value">–û–∂–∏–¥–∞–Ω–∏–µ</div></div>
        </div>

        <div class="chart-container">
            <div id="chart"></div>
        </div>

        <pre id="analysisText">–ì—Ä–∞—Ñ–∏–∫ –∏ –∞–Ω–∞–ª–∏–∑ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å...</pre>
    </div>

    <script>
        // --- –î–∞—Ç—ã ---
        document.getElementById('tillDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('fromDate').value = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

        let rawData = [];
        let chart = null;

        // --- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã ---
        function calcSMA(data, period) {
            let sma = [];
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) { sma.push(null); continue; }
                let sum = 0;
                for (let j = i - period + 1; j <= i; j++) sum += data[j].close;
                sma.push(sum / period);
            }
            return sma;
        }

        function calcRSI(data, period = 14) {
            let rsi = [];
            let gains = 0, losses = 0;
            for (let i = 1; i <= period; i++) {
                let diff = data[i].close - data[i-1].close;
                if (diff > 0) gains += diff; else losses -= diff;
            }
            let avgGain = gains / period;
            let avgLoss = losses / period;
            
            for (let i = 0; i < data.length; i++) {
                if (i < period) { rsi.push(null); continue; }
                if (i > period) {
                    let diff = data[i].close - data[i-1].close;
                    avgGain = (avgGain * (period - 1) + (diff > 0 ? diff : 0)) / period;
                    avgLoss = (avgLoss * (period - 1) + (diff < 0 ? -diff : 0)) / period;
                }
                let rs = avgLoss === 0 ? 100 : avgGain / avgLoss;
                rsi.push(100 - (100 / (1 + rs)));
            }
            return rsi;
        }

        // --- –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö ---
        document.getElementById('loadDataBtn').addEventListener('click', async () => {
            const username = document.getElementById('moexUsername').value.trim();
            const password = document.getElementById('moexPassword').value.trim();
            const fromVal = document.getElementById('fromDate').value;
            const tillVal = document.getElementById('tillDate').value;
            const statusEl = document.getElementById('status');

            statusEl.style.display = 'block'; statusEl.className = 'status-msg success'; statusEl.innerText = "‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å –±–∏—Ä–∂–∏...";

            try {
                const response = await fetch('/api/proxy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, from: fromVal, till: tillVal })
                });

                const result = await response.json();
                if (!response.ok) throw new Error(result.error);
                if (result.warning) throw new Error(result.warning);
                if (!result.candles || !result.candles.data.length) throw new Error("–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç");

                const cols = result.candles.columns;
                const rows = result.candles.data;
                const idx = {
                    open: cols.indexOf('open'), close: cols.indexOf('close'),
                    high: cols.indexOf('high'), low: cols.indexOf('low'),
                    volume: cols.indexOf('volume'), begin: cols.indexOf('begin')
                };

                rawData = rows.map(r => {
                    const timeObj = new Date(r[idx.begin].replace(' ', 'T') + '+03:00');
                    return {
                        time: Math.floor(timeObj.getTime() / 1000),
                        open: parseFloat(r[idx.open]), high: parseFloat(r[idx.high]),
                        low: parseFloat(r[idx.low]), close: parseFloat(r[idx.close]),
                        volume: parseFloat(r[idx.volume])
                    };
                }).sort((a,b) => a.time - b.time);

                drawChart();
                updatePanel();
                statusEl.innerText = `‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${rawData.length} —Å–≤–µ—á–µ–π. –ì–æ—Ç–æ–≤–æ –∫ –∞–Ω–∞–ª–∏–∑—É.`;
                document.getElementById('analyzeBtn').disabled = false;

            } catch (e) {
                statusEl.className = 'status-msg error';
                statusEl.innerText = "‚ùå " + e.message;
            }
        });

        function drawChart() {
            const container = document.getElementById('chart');
            if(chart) chart.remove();
            chart = LightweightCharts.createChart(container, { 
                layout: { backgroundColor: '#2a2c39', textColor: '#d1d4dc' },
                grid: { vertLines: { color: '#404254' }, horzLines: { color: '#404254' } },
                timeScale: { timeVisible: true }
            });
            const series = chart.addCandlestickSeries({
                upColor: '#4caf50', downColor: '#f44336',
                borderUpColor: '#4caf50', borderDownColor: '#f44336'
            });
            series.setData(rawData);
            chart.timeScale().fitContent();
        }

        function updatePanel() {
            if(!rawData.length) return;
            const last = rawData[rawData.length-1];
            document.getElementById('indicatorsPanel').innerHTML = `
                <div class="indicator-card"><h3>–¶–µ–Ω–∞</h3><div class="value">${last.close.toFixed(2)}</div></div>
                <div class="indicator-card"><h3>–û–±—ä–µ–º</h3><div class="value">${last.volume}</div></div>
            `;
        }

        // --- –ê–ù–ê–õ–ò–ó –° –ê–í–¢–û-–ù–û–í–û–°–¢–Ø–ú–ò ---
        document.getElementById('analyzeBtn').addEventListener('click', async () => {
            const key = document.getElementById('deepseekApiKey').value;
            if(!key) return alert("–í–≤–µ–¥–∏—Ç–µ API Key");
            if(rawData.length === 0) return alert("–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ");

            const btn = document.getElementById('analyzeBtn');
            const out = document.getElementById('analysisText');
            const statusEl = document.getElementById('status');
            const newsBox = document.getElementById('newsBox');
            const newsContent = document.getElementById('newsContent');
            
            btn.disabled = true;
            btn.innerText = "‚è≥ –ü–æ–ª—É—á–∞—é –Ω–æ–≤–æ—Å—Ç–∏...";
            statusEl.style.display = 'block';
            statusEl.className = 'status-msg success';
            out.innerText = "–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö...";

            try {
                // –®–∞–≥ 1: –ü–æ–ª—É—á–∞–µ–º –Ω–æ–≤–æ—Å—Ç–∏
                statusEl.innerText = "‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π (Google News)...";
                const newsRes = await fetch('/api/proxy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'getNews' })
                });
                const newsData = await newsRes.json();
                const newsText = newsData.news;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–æ–≤–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                newsContent.innerText = newsText;
                newsBox.style.display = 'block';
                statusEl.innerText = "‚è≥ –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –≥—Ä–∞—Ñ–∏–∫ –∏ –Ω–æ–≤–æ—Å—Ç–∏ –≤ DeepSeek...";

                // –®–∞–≥ 2: –ì–æ—Ç–æ–≤–∏–º –¥–∞–Ω–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∞
                const sma20 = calcSMA(rawData, 20);
                const rsi14 = calcRSI(rawData, 14);
                const window = rawData.slice(-48);
                
                let csv = "Date,Open,High,Low,Close,Volume,SMA20,RSI14\n";
                window.forEach((d, i) => {
                    const idx = rawData.length - window.length + i;
                    const dateStr = new Date(d.time*1000).toISOString().replace('T', ' ').substring(0, 16);
                    const s = sma20[idx] ? sma20[idx].toFixed(2) : '';
                    const r = rsi14[idx] ? rsi14[idx].toFixed(2) : '';
                    csv += `${dateStr},${d.open},${d.high},${d.low},${d.close},${d.volume},${s},${r}\n`;
                });

                // –®–∞–≥ 3: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ DeepSeek
                const systemPrompt = `–¢—ã –∞–Ω–∞–ª–∏—Ç–∏–∫ MOEX. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ñ—å—é—á–µ—Ä—Å Si (–¥–æ–ª–ª–∞—Ä/—Ä—É–±–ª—å).
–£ —Ç–µ–±—è –µ—Å—Ç—å:
1. –°–≤–µ—á–∏ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 48 —á–∞—Å–æ–≤), –æ–±—ä–µ–º—ã, SMA20, RSI14.
2. –°–≤–µ–∂–∏–µ –Ω–æ–≤–æ—Å—Ç–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏.
–£—á—Ç–∏ –≤–ª–∏—è–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–µ–π –Ω–∞ –≤–∞–ª—é—Ç–Ω—ã–π —Ä—ã–Ω–æ–∫. –î–∞–π –ø—Ä–æ–≥–Ω–æ–∑ –∏ —Ç–æ—á–∫–∏ –≤—Ö–æ–¥–∞/–≤—ã—Ö–æ–¥–∞.`;

                const userPrompt = `
–¢–ò–ö–ï–†: SiH6 (Si-3.26)
–ü–û–°–õ–ï–î–ù–Ø–Ø –¶–ï–ù–ê: ${rawData[rawData.length-1].close}

–î–ê–ù–ù–´–ï –ì–†–ê–§–ò–ö–ê (CSV):
 ${csv}

–°–í–ï–ñ–ò–ï –ù–û–í–û–°–¢–ò (RSS):
 ${newsText}

–ó–ê–î–ê–ß–ê:
–ü—Ä–æ–≤–µ–¥–∏ –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞–Ω–∞–ª–∏–∑. –ö–∞–∫ –Ω–æ–≤–æ—Å—Ç–∏ –≤–ª–∏—è—é—Ç –Ω–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫—É—é –∫–∞—Ä—Ç–∏–Ω—É? –ö—É–¥–∞ –ø–æ–π–¥–µ—Ç —Ü–µ–Ω–∞?
                `;

                const res = await fetch('/api/proxy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: [
                            { role: 'system', content: systemPrompt },
                            { role: 'user', content: userPrompt }
                        ],
                        temperature: 0.2
                    })
                });
                const data = await res.json();
                if(data.error) throw new Error(data.error.message);
                
                out.innerText = data.choices[0].message.content;
                statusEl.innerText = "‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω.";

            } catch(e) {
                out.innerText = "–û—à–∏–±–∫–∞: " + e.message;
                statusEl.className = 'status-msg error';
                statusEl.innerText = "‚ùå –û—à–∏–±–∫–∞";
            } finally {
                btn.disabled = false;
                btn.innerText = "üîç –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–≥–Ω–æ–∑ (–ê–≤—Ç–æ-–Ω–æ–≤–æ—Å—Ç–∏ + –ì—Ä–∞—Ñ–∏–∫)";
            }
        });
    </script>
</body>
</html>
