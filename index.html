<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Si-3.26 Quant Terminal</title>
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#1e222d">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <style>
        :root {
            --bg-main: #131722; --bg-panel: #1e222d; --bg-card: #2a2e39; --bg-hover: #363a45;
            --text-main: #d1d4dc; --text-muted: #787b86; --accent-green: #26a69a;
            --accent-red: #ef5350; --accent-blue: #2962ff; --border-color: #363a45;
        }
        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        body { background: var(--bg-main); color: var(--text-main); margin: 0; padding: 20px; line-height: 1.5; }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 20px; font-weight: 500; }
        .live-badge { background: var(--accent-red); padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; animation: pulse 2s infinite; display: flex; align-items: center; gap: 5px; }
        .live-badge::before { content: ''; width: 6px; height: 6px; background: white; border-radius: 50%; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
        .grid-2 { display: grid; grid-template-columns: 1fr 380px; gap: 20px; }
        @media (max-width: 1000px) { .grid-2 { grid-template-columns: 1fr; } }
        .panel { background: var(--bg-panel); border-radius: 8px; padding: 20px; margin-bottom: 20px; border: 1px solid var(--border-color); }
        .controls-row { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        input { background: var(--bg-main); border: 1px solid var(--border-color); color: var(--text-main); padding: 10px; border-radius: 6px; flex: 1; min-width: 120px; outline: none; }
        button { background: var(--accent-blue); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
        button:hover { opacity: 0.9; } button:disabled { background: #444; cursor: not-allowed; }
        .btn-analyze { background: linear-gradient(45deg, #2e7d32, #43a047); width: 100%; margin-top: 10px; font-size: 16px; padding: 12px; }
        .btn-stop { background: #c62828; }
        .stats-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 20px; }
        .stat-card { background: var(--bg-panel); padding: 12px; border-radius: 6px; text-align: center; border: 1px solid var(--border-color); }
        .stat-label { font-size: 11px; color: var(--text-muted); margin-bottom: 4px; text-transform: uppercase; }
        .stat-value { font-size: 16px; font-weight: 600; transition: color 0.2s; }
        #chart { width: 100%; height: 450px; background: var(--bg-panel); border-radius: 8px; border: 1px solid var(--border-color); }
        
        /* AI Styles */
        .ai-header { border-bottom: 1px solid var(--border-color); margin-bottom: 20px; padding-bottom: 10px; }
        .signal-badge { padding: 6px 16px; border-radius: 4px; font-weight: 700; text-transform: uppercase; font-size: 14px; }
        .signal-long { background: rgba(38, 166, 154, 0.15); color: var(--accent-green); border: 1px solid rgba(38, 166, 154, 0.3); }
        .signal-short { background: rgba(239, 83, 80, 0.15); color: var(--accent-red); border: 1px solid rgba(239, 83, 80, 0.3); }
        .signal-neutral { background: rgba(41, 98, 255, 0.15); color: var(--accent-blue); border: 1px solid rgba(41, 98, 255, 0.3); }
        .levels-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px; text-align: center; }
        .level-box { padding: 12px; border-radius: 4px; background: var(--bg-card); border: 1px solid var(--border-color); }
        .level-val { font-size: 20px; font-weight: 700; margin-top: 4px; font-family: monospace; }
        .tp-color { color: var(--accent-green); } .sl-color { color: var(--accent-red); } .entry-color { color: var(--accent-blue); }
        .prediction-block { margin-bottom: 20px; padding: 20px; background: repeating-linear-gradient(45deg, var(--bg-card), var(--bg-card) 10px, var(--bg-panel) 10px, var(--bg-panel) 20px); border-radius: 6px; border: 1px solid var(--border-color); text-align: center; }
        .pred-inner { background: var(--bg-panel); padding: 15px; border-radius: 4px; }
        .pred-title { font-size: 12px; color: var(--text-muted); margin-bottom: 10px; text-transform: uppercase; }
        .pred-direction { font-size: 36px; font-weight: 800; margin-bottom: 5px; text-transform: uppercase; }
        .pred-prob-bar { height: 6px; background: #000; border-radius: 3px; overflow: hidden; margin-top: 10px; width: 100%; }
        .pred-prob-fill { height: 100%; transition: width 0.5s; }
        .pred-prob-text { font-size: 13px; color: var(--text-muted); margin-top: 5px; }
        .logic-box { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 4px; margin-bottom: 20px; border-left: 3px solid var(--accent-blue); font-size: 14px; }
        .analysis-content { background: var(--bg-main); padding: 15px; border-radius: 6px; line-height: 1.6; font-size: 13px; max-height: 350px; overflow-y: auto; border: 1px solid var(--border-color); }
        .analysis-content h3 { color: var(--text-main); margin: 0 0 10px 0; font-size: 13px; font-weight: 600; text-transform: uppercase; }
        .analysis-content p { margin: 0 0 15px 0; color: #b0b7ca; }
        .loader { display: inline-block; width: 20px; height: 20px; border: 2px solid #fff; border-radius: 50%; border-top-color: transparent; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .status { font-size: 12px; margin-top: 5px; padding: 8px; border-radius: 4px; display: none; }
    </style>
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
</head>
<body>
    <div class="container">
        <h1><span>üìà Si-3.26 Quant Terminal</span><span id="liveBadge" style="display:none" class="live-badge">LIVE</span></h1>
        <div class="stats-grid">
            <div class="stat-card"><div class="stat-label">–¶–µ–Ω–∞ (Real)</div><div class="stat-value" id="sPrice">--</div></div>
            <div class="stat-card"><div class="stat-label">–¢—Ä–µ–Ω–¥</div><div class="stat-value" id="sTrend">--</div></div>
            <div class="stat-card"><div class="stat-label">ATR</div><div class="stat-value" id="sAtr">--</div></div>
            <div class="stat-card"><div class="stat-label">RSI</div><div class="stat-value" id="sRsi">--</div></div>
            <div class="stat-card"><div class="stat-label">MACD</div><div class="stat-value" id="sMacd">--</div></div>
        </div>
        <div class="grid-2">
            <div>
                <div class="panel">
                    <div class="controls-row">
                        <input type="text" id="user" placeholder="–õ–æ–≥–∏–Ω MOEX">
                        <input type="password" id="pass" placeholder="–ü–∞—Ä–æ–ª—å MOEX">
                    </div>
                    <div class="controls-row">
                        <input type="date" id="from">
                        <input type="date" id="to">
                        <button id="loadBtn">‚ñ∂ –ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
                        <button id="stopBtn" style="display:none;" class="btn-stop">‚ñ† –°—Ç–æ–ø</button>
                    </div>
                    <div class="status" id="statusBox"></div>
                </div>
                <div id="chart"></div>
            </div>
            <div class="panel" style="height: fit-content;">
                <h2 style="margin-top:0; font-size:18px;">ü§ñ –ü—Ä–æ–≥–Ω–æ–∑–Ω—ã–π –º–æ–¥—É–ª—å</h2>
                <input type="password" id="aiKey" placeholder="DeepSeek API Key" style="width:100%; margin-bottom:10px;">
                <button id="analyzeBtn" disabled class="btn-analyze">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–≥–Ω–æ–∑</button>
                <div id="aiResultContainer" style="margin-top:20px; display:none;"></div>
            </div>
        </div>
    </div>

    <script>
        // --- Setup & Indicators (Condensed for brevity, logic remains same) ---
        document.getElementById('to').value = new Date().toISOString().split('T')[0];
        document.getElementById('from').value = new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
        let chart = null, candleSeries = null, smaLineSeries = null, candles = [], indicators = {}, updateTimer = null, priceLines = []; 
        const $ = id => document.getElementById(id);
        const showStatus = (msg, isError=false) => { const el = $('statusBox'); el.style.display = 'block'; el.className = 'status ' + (isError ? 'status-err' : 'status-ok'); el.innerText = msg; };

        // Math Helpers
        const calcSMA = (d, p) => d.map((v,i,a) => i<p-1?null:a.slice(i-p+1,i+1).reduce((s,x)=>s+x.close,0)/p);
        const calcRSI = (d, p=14) => { let rsi=[], g=0,l=0; for(let i=1;i<=p;i++){let df=d[i].close-d[i-1].close; df>0?g+=df:l-=df;} let ag=g/p,al=l/p; for(let i=0;i<d.length;i++){ if(i<p){rsi.push(null);continue} if(i>p){let df=d[i].close-d[i-1].close; ag=(ag*(p-1)+(df>0?df:0))/p; al=(al*(p-1)+(df<0?-df:0))/p} rsi.push(al==0?100:100-100/(1+ag/al))} return rsi };
        const calcEMA = (d, p) => { let ema=[], k=2/(p+1), sum=0; for(let i=0;i<p;i++) sum+=d[i].close; ema[p-1]=sum/p; for(let i=p;i<d.length;i++) ema[i]=d[i].close*k+ema[i-1]*(1-k); return ema; };
        const calcMACD = (d) => { const e12=calcEMA(d,12), e26=calcEMA(d,26); let ml=[],sl=[]; for(let i=0;i<d.length;i++) e26[i]?ml.push(e12[i]-e26[i]):ml.push(null); let fv=ml.findIndex(x=>x!==null); for(let i=0;i<fv+8;i++) sl.push(null); for(let i=fv+8;i<d.length;i++) i==fv+8?sl.push(ml[i]):sl.push(ml[i]*(2/10)+sl[sl.length-1]*(1-2/10)); return {macdLine:ml, signalLine:sl}; };
        const calcATR = (d,p=14) => { let tr=[]; for(let i=0;i<d.length;i++){ if(i==0){tr.push(d[i].high-d[i].low);continue} tr.push(Math.max(d[i].high,d[i-1].close)-Math.min(d[i].low,d[i-1].close))} let atr=[]; for(let i=0;i<d.length;i++){ if(i<p-1){atr.push(null);continue} let s=0; for(let j=i-p+1;j<=i;j++) s+=tr[j]; atr.push(s/p)} return atr; };
        const analyzeTrend = (d) => { if(d.length<5) return "–ù/–î"; const l5=d.slice(-5); let hh=true,ll=true; for(let i=1;i<5;i++){if(l5[i].high<l5[i-1].high)hh=false;if(l5[i].low>l5[i-1].low)ll=false} return (hh&&!ll)?"–ë—ã—á–∏–π":((ll&&!hh)?"–ú–µ–¥–≤–µ–∂–∏–π":"–ë–æ–∫–æ–≤–∏–∫"); };

        // Logic
        $('loadBtn').onclick = async () => {
            $('loadBtn').disabled = true; showStatus('‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...');
            try {
                const res = await fetch('/api/proxy', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ username: $('user').value, password: $('pass').value, from: $('from').value, till: $('to').value, interval: 60 }) });
                const data = await res.json(); if (!res.ok || data.warning) throw new Error(data.error || data.warning);
                const cols = data.candles.columns;
                const idx = { o: cols.indexOf('open'), c: cols.indexOf('close'), h: cols.indexOf('high'), l: cols.indexOf('low'), v: cols.indexOf('volume'), t: cols.indexOf('begin') };
                candles = data.candles.data.map(r => ({ time: Math.floor(new Date(r[idx.t].replace(' ','T')+'+03:00')/1000), open: +r[idx.o], high: +r[idx.h], low: +r[idx.l], close: +r[idx.c], volume: +r[idx.v] })).sort((a,b)=>a.time-b.time);
                updateIndicators(); initChart(); updateStats(); startLive();
                $('loadBtn').style.display = 'none'; $('stopBtn').style.display = 'block'; $('liveBadge').style.display = 'inline-block'; $('analyzeBtn').disabled = false;
                showStatus('‚úÖ –ó–∞–ø—É—â–µ–Ω–æ.');
            } catch(e) { showStatus(e.message, true); $('loadBtn').disabled = false; }
        };
        $('stopBtn').onclick = () => { clearInterval(updateTimer); $('stopBtn').style.display = 'none'; $('loadBtn').style.display = 'block'; $('loadBtn').disabled = false; $('liveBadge').style.display = 'none'; };
        
        function startLive() {
            const tick = async () => {
                try { const pRes = await fetch('/api/proxy', { method:'POST', headers:{'C':'application/json'}, body: JSON.stringify({action:'getLastTrade'})}); const pD = await pRes.json(); if(pD.price){ const el = $('sPrice'); const old = parseFloat(el.innerText); el.innerText = pD.price.toFixed(2); el.style.color = pD.price > old ? 'var(--accent-green)' : 'var(--accent-red)'; } } catch(e) {}
                try {
                    const now = new Date(); const from = new Date(now.getTime() - 2 * 60 * 60 * 1000).toISOString().split('T')[0];
                    const res = await fetch('/api/proxy', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ username: $('user').value, password: $('pass').value, from: from, till: now.toISOString().split('T')[0], interval: 1 }) });
                    const data = await res.json(); if (data.candles && data.candles.data.length > 0) processMinuteData(data.candles);
                } catch(e) {}
            };
            tick(); updateTimer = setInterval(tick, 30000);
        }

        function processMinuteData(candlesData) {
            const cols = candlesData.columns; const rows = candlesData.data;
            const idx = { o: cols.indexOf('open'), c: cols.indexOf('close'), h: cols.indexOf('high'), l: cols.indexOf('low'), v: cols.indexOf('volume'), t: cols.indexOf('begin') };
            const nowUTCTs = Math.floor(Date.now() / 1000); const currentHourStartTs = Math.floor(nowUTCTs / 3600) * 3600;
            const minuteCandles = rows.map(r => ({ time: Math.floor(new Date(r[idx.t].replace(' ','T')+'+03:00')/1000), open: +r[idx.o], high: +r[idx.h], low: +r[idx.l], close: +r[idx.c], volume: +r[idx.v] }));
            const currentHourMinutes = minuteCandles.filter(c => c.time >= currentHourStartTs); if (currentHourMinutes.length === 0) return;
            const liveCandle = { time: currentHourStartTs, open: currentHourMinutes[0].open, high: Math.max(...currentHourMinutes.map(c => c.high)), low: Math.min(...currentHourMinutes.map(c => c.low)), close: currentHourMinutes[currentHourMinutes.length - 1].close, volume: currentHourMinutes.reduce((sum, c) => sum + c.volume, 0) };
            const lastHistoryCandle = candles[candles.length - 1];
            if (lastHistoryCandle.time === liveCandle.time) candles[candles.length - 1] = liveCandle;
            else if (liveCandle.time > lastHistoryCandle.time) { candles.push(liveCandle); updateIndicators(); }
            else return;
            if (candleSeries) candleSeries.update(liveCandle);
            if (smaLineSeries) { const smaData = candles.map((c, i) => indicators.sma[i] ? { time: c.time, value: indicators.sma[i] } : null).filter(Boolean); smaLineSeries.setData(smaData); }
            const rsiVal = indicators.rsi[indicators.rsi.length-1]; $('sRsi').innerText = rsiVal ? rsiVal.toFixed(1) : '--'; $('sTrend').innerText = indicators.trend;
        }

        function updateIndicators() { indicators.sma = calcSMA(candles, 20); indicators.rsi = calcRSI(candles, 14); indicators.macd = calcMACD(candles); indicators.atr = calcATR(candles, 14); indicators.trend = analyzeTrend(candles); }
        function initChart() {
            if(chart) chart.remove();
            chart = LightweightCharts.createChart('chart', { layout: { backgroundColor: '#1e222d', textColor: '#d1d4dc' }, grid: { vertLines: { color: '#2a2e39' }, horzLines: { color: '#2a2e39' } }, timeScale: { timeVisible: true } });
            candleSeries = chart.addCandlestickSeries({ upColor: '#26a69a', downColor: '#ef5350', borderUpColor: '#26a69a', borderDownColor: '#ef5350' });
            candleSeries.setData(candles);
            smaLineSeries = chart.addLineSeries({ color: '#2962ff', lineWidth: 2 });
            const smaData = candles.map((c, i) => indicators.sma[i] ? { time: c.time, value: indicators.sma[i] } : null).filter(Boolean); smaLineSeries.setData(smaData);
            chart.timeScale().fitContent(); window.addEventListener('resize', () => chart.applyOptions({width: $('chart').clientWidth}));
        }
        function updateStats() { if(!candles.length) return; const last = candles[candles.length-1]; const atrVal = indicators.atr[indicators.atr.length-1]; const macdVal = indicators.macd.macdLine[indicators.macd.macdLine.length-1]; $('sPrice').innerText = last.close.toFixed(2); $('sTrend').innerText = indicators.trend; $('sAtr').innerText = atrVal ? atrVal.toFixed(0) : '--'; if(macdVal) { $('sMacd').innerText = macdVal.toFixed(0); $('sMacd').style.color = macdVal > 0 ? 'var(--accent-green)' : 'var(--accent-red)'; } }

        // AI Analysis
        $('analyzeBtn').onclick = async () => {
            const key = $('aiKey').value; if(!key) return alert("–í–≤–µ–¥–∏—Ç–µ DeepSeek API Key");
            const btn = $('analyzeBtn'); const container = $('aiResultContainer');
            btn.disabled = true; btn.innerHTML = '<div class="loader"></div> –ê–Ω–∞–ª–∏–∑...'; container.style.display = 'none';
            try {
                const newsRes = await fetch('/api/proxy', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({action:'getNews'}) });
                const newsData = await newsRes.json();
                const last = candles[candles.length-1]; const atr = indicators.atr[indicators.atr.length-1]; const rsi = indicators.rsi[indicators.rsi.length-1]; const sma = indicators.sma[indicators.sma.length-1]; const lastMacd = indicators.macd.macdLine[indicators.macd.macdLine.length-1];
                const systemPrompt = `–¢—ã –ø—Ä–æ—Ñ–∏ —Ç—Ä–µ–π–¥–µ—Ä. –î–∞–π –ø—Ä–æ–≥–Ω–æ–∑ (–†–û–°–¢/–ü–ê–î–ï–ù–ò–ï/–ë–û–ö–û–í–ò–ö). JSON: { "signal": "LONG/SHORT/NEUTRAL", "entry_price": —á–∏—Å–ª–æ, "take_profit": —á–∏—Å–ª–æ, "stop_loss": —á–∏—Å–ª–æ, "prediction": { "direction": "...", "probability": —á–∏—Å–ª–æ }, "summary": "...", "analysis": "...", "risks": "..." }`;
                const userPrompt = `–¶–ï–ù–ê: ${last.close}. RSI: ${rsi?.toFixed(1)}. SMA: ${sma?.toFixed(1)}. MACD: ${lastMacd?.toFixed(1)}. –ù–û–í–û–°–¢–ò: ${newsData.news}`;
                const aiRes = await fetch('/api/proxy', { method: 'POST', headers: {'Content-Type':'application/json', 'Authorization': `Bearer ${key}`}, body: JSON.stringify({ model: 'deepseek-chat', messages: [{role: 'system', content: systemPrompt}, {role: 'user', content: userPrompt}], temperature: 0.1 }) });
                const aiData = await aiRes.json(); if(aiData.error) throw new Error(aiData.error.message);
                const content = aiData.choices[0].message.content;
                let parsed; try { parsed = JSON.parse(content.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim()); } catch (e) { throw new Error("JSON Error"); }
                renderAnalysis(parsed, container); drawLevels(parsed);
            } catch(e) { container.style.display = 'block'; container.innerHTML = `<div style="color:var(--accent-red);">–û—à–∏–±–∫–∞: ${e.message}</div>`; }
            finally { btn.disabled = false; btn.innerText = '–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–≥–Ω–æ–∑'; }
        };
        function renderAnalysis(data, container) {
            const signalClass = data.signal === 'LONG' ? 'signal-long' : (data.signal === 'SHORT' ? 'signal-short' : 'signal-neutral');
            const pred = data.prediction || { direction: '–ù/–î', probability: 0 }; let predColor = pred.direction === '–†–û–°–¢' ? 'var(--accent-green)' : (pred.direction === '–ü–ê–î–ï–ù–ò–ï' ? 'var(--accent-red)' : 'var(--accent-blue)');
            container.innerHTML = `<div class="ai-header"><h2 style="margin:0;font-size:16px;">–°–∏–≥–Ω–∞–ª: <span class="signal-badge ${signalClass}">${data.signal}</span></h2></div><div class="levels-grid"><div class="level-box"><div class="stat-label">–í—Ö–æ–¥</div><div class="level-val entry-color">${data.entry_price}</div></div><div class="level-box"><div class="stat-label">–¢–µ–π–∫</div><div class="level-val tp-color">${data.take_profit}</div></div><div class="level-box"><div class="stat-label">–°—Ç–æ–ø</div><div class="level-val sl-color">${data.stop_loss}</div></div></div><div class="prediction-block"><div class="pred-inner"><div class="pred-title">üîÆ –ü—Ä–æ–≥–Ω–æ–∑</div><div class="pred-direction" style="color:${predColor}">${pred.direction}</div><div class="pred-prob-bar"><div class="pred-prob-fill" style="width:${pred.probability}%; background:${predColor};"></div></div><div class="pred-prob-text">–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å: <b style="color:${predColor}">${pred.probability}%</b></div></div></div><div class="logic-box"><b>‚ö° –õ–æ–≥–∏–∫–∞:</b> ${data.summary}</div><div class="analysis-content"><h3>–¢–µ—Ö. –∞–Ω–∞–ª–∏–∑</h3><p>${data.analysis}</p><h3>–†–∏—Å–∫–∏</h3><p>${data.risks}</p></div>`;
            container.style.display = 'block';
        }
        function drawLevels(data) { if (!candleSeries) return; priceLines.forEach(line => candleSeries.removePriceLine(line)); priceLines = []; const createLine = (price, color, title) => { if(!price) return; priceLines.push(candleSeries.createPriceLine({ price: price, color: color, lineWidth: 2, lineStyle: 2, axisLabelVisible: true, title: title })); }; createLine(data.entry_price, '#2962ff', 'Entry'); createLine(data.take_profit, '#26a69a', 'TP'); createLine(data.stop_loss, '#ef5350', 'SL'); }

        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) { navigator.serviceWorker.register('/sw.js'); }
    </script>
</body>
</html>
