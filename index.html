<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Si-3.26 AI Terminal (Live Fix)</title>
    <style>
        :root {
            --bg-main: #131722;
            --bg-panel: #1e222d;
            --bg-card: #2a2e39;
            --text-main: #d1d4dc;
            --text-muted: #787b86;
            --accent-green: #26a69a;
            --accent-red: #ef5350;
            --accent-blue: #2962ff;
        }
        
        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        body { background: var(--bg-main); color: var(--text-main); margin: 0; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        
        h1 { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--bg-card); padding-bottom: 15px; margin-bottom: 20px; }
        .live-badge { background: var(--accent-red); padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        .grid-2 { display: grid; grid-template-columns: 1fr 350px; gap: 20px; }
        @media (max-width: 1000px) { .grid-2 { grid-template-columns: 1fr; } }
        
        .panel { background: var(--bg-panel); border-radius: 8px; padding: 20px; margin-bottom: 20px; }
        
        .controls-row { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        input { background: var(--bg-main); border: 1px solid var(--bg-card); color: var(--text-main); padding: 10px; border-radius: 6px; flex: 1; min-width: 120px; }
        button { background: var(--accent-blue); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; }
        button:hover { opacity: 0.9; }
        button:disabled { background: #444; cursor: not-allowed; }
        .btn-analyze { background: linear-gradient(45deg, #2e7d32, #43a047); width: 100%; margin-top: 10px; font-size: 16px; padding: 12px; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
        .stat-card { background: var(--bg-panel); padding: 15px; border-radius: 6px; text-align: center; }
        .stat-label { font-size: 12px; color: var(--text-muted); margin-bottom: 5px; }
        .stat-value { font-size: 18px; font-weight: 600; }

        #chart { width: 100%; height: 500px; background: var(--bg-panel); border-radius: 8px; }

        .ai-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .signal-badge { padding: 5px 15px; border-radius: 20px; font-weight: bold; text-transform: uppercase; font-size: 14px; }
        .signal-long { background: rgba(38, 166, 154, 0.2); color: var(--accent-green); border: 1px solid var(--accent-green); }
        .signal-short { background: rgba(239, 83, 80, 0.2); color: var(--accent-red); border: 1px solid var(--accent-red); }
        .signal-neutral { background: rgba(41, 98, 255, 0.2); color: var(--accent-blue); border: 1px solid var(--accent-blue); }

        .levels-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; text-align: center; }
        .level-box { padding: 10px; border-radius: 6px; background: var(--bg-card); }
        .level-val { font-size: 18px; font-weight: bold; margin-top: 5px; }
        .tp-color { color: var(--accent-green); }
        .sl-color { color: var(--accent-red); }
        .entry-color { color: var(--accent-blue); }

        .analysis-content { background: var(--bg-main); padding: 15px; border-radius: 6px; line-height: 1.6; font-size: 14px; max-height: 400px; overflow-y: auto; }
        
        .loader { display: inline-block; width: 20px; height: 20px; border: 2px solid #fff; border-radius: 50%; border-top-color: transparent; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .status { font-size: 12px; margin-top: 5px; padding: 8px; border-radius: 4px; display: none; }
        .status-ok { background: #234427; color: var(--accent-green); }
        .status-err { background: #442326; color: var(--accent-red); }
    </style>
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
</head>
<body>
    <div class="container">
        <h1>
            <span>üìà Si-3.26 AI Terminal</span>
            <span id="liveBadge" style="display:none" class="live-badge">LIVE DATA</span>
        </h1>

        <div class="stats-grid" id="statsGrid">
            <div class="stat-card"><div class="stat-label">–¶–µ–Ω–∞ (Live)</div><div class="stat-value" id="sPrice">--</div></div>
            <div class="stat-card"><div class="stat-label">High (Hour)</div><div class="stat-value" id="sHigh">--</div></div>
            <div class="stat-card"><div class="stat-label">Low (Hour)</div><div class="stat-value" id="sLow">--</div></div>
            <div class="stat-card"><div class="stat-label">RSI(14)</div><div class="stat-value" id="sRsi">--</div></div>
        </div>

        <div class="grid-2">
            <div>
                <div class="panel">
                    <div class="controls-row">
                        <input type="text" id="user" placeholder="MOEX Login">
                        <input type="password" id="pass" placeholder="MOEX Password">
                    </div>
                    <div class="controls-row">
                        <input type="date" id="from">
                        <input type="date" id="to">
                        <button id="loadBtn">‚ñ∂ –ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
                        <button id="stopBtn" style="display:none; background:#c62828;">‚ñ† –°—Ç–æ–ø</button>
                    </div>
                    <div class="status" id="statusBox"></div>
                </div>
                <div id="chart"></div>
            </div>

            <div class="panel" style="height: fit-content;">
                <h2 style="margin-top:0; font-size:18px;">ü§ñ AI –ê–Ω–∞–ª–∏—Ç–∏–∫</h2>
                <input type="password" id="aiKey" placeholder="DeepSeek API Key" style="width:100%; margin-bottom:10px;">
                <button id="analyzeBtn" disabled class="btn-analyze">–ü–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–≥–Ω–æ–∑ –∏ —É—Ä–æ–≤–Ω–∏</button>
                
                <div id="aiResultContainer" style="margin-top:20px; display:none;"></div>
                <pre id="rawLog" style="display:none; font-size:10px; color:#666; margin-top:10px;"></pre>
            </div>
        </div>
    </div>

    <script>
        // --- Setup ---
        document.getElementById('to').value = new Date().toISOString().split('T')[0];
        document.getElementById('from').value = new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

        let chart = null, candleSeries = null;
        let candles = [], indicators = {};
        let updateTimer = null;
        let priceLines = []; 

        // --- Indicators ---
        const calcSMA = (d, p) => d.map((v,i,a) => i<p-1?null:a.slice(i-p+1,i+1).reduce((s,x)=>s+x.close,0)/p);
        const calcRSI = (d, p=14) => {
            let rsi=[], g=0, l=0;
            for(let i=1; i<=p; i++){ let df=d[i].close-d[i-1].close; df>0?g+=df:l-=df; }
            let ag=g/p, al=l/p;
            for(let i=0; i<d.length; i++){
                if(i<p){rsi.push(null);continue;}
                if(i>p){let df=d[i].close-d[i-1].close; ag=(ag*(p-1)+(df>0?df:0))/p; al=(al*(p-1)+(df<0?-df:0))/p;}
                rsi.push(al==0?100:100-100/(1+ag/al));
            }
            return rsi;
        };

        // --- Core Logic ---
        const $ = id => document.getElementById(id);
        const showStatus = (msg, isError=false) => {
            const el = $('statusBox');
            el.style.display = 'block';
            el.className = 'status ' + (isError ? 'status-err' : 'status-ok');
            el.innerText = msg;
        };

        // 1. INITIAL LOAD (HISTORY)
        $('loadBtn').onclick = async () => {
            $('loadBtn').disabled = true;
            showStatus('‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ (H1)...');
            try {
                const res = await fetch('/api/proxy', {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({
                        username: $('user').value, password: $('pass').value,
                        from: $('from').value, till: $('to').value, 
                        interval: 60 // –ó–∞–≥—Ä—É–∂–∞–µ–º —á–∞—Å–æ–≤—ã–µ —Å–≤–µ—á–∏ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
                    })
                });
                const data = await res.json();
                if (!res.ok || data.warning) throw new Error(data.error || data.warning);

                const cols = data.candles.columns;
                const idx = { o: cols.indexOf('open'), c: cols.indexOf('close'), h: cols.indexOf('high'), l: cols.indexOf('low'), v: cols.indexOf('volume'), t: cols.indexOf('begin') };
                
                candles = data.candles.data.map(r => ({
                    time: Math.floor(new Date(r[idx.t].replace(' ','T')+'+03:00')/1000),
                    open: +r[idx.o], high: +r[idx.h], low: +r[idx.l], close: +r[idx.c], volume: +r[idx.v]
                })).sort((a,b)=>a.time-b.time);

                indicators.sma = calcSMA(candles, 20);
                indicators.rsi = calcRSI(candles);

                initChart();
                updateStats();
                
                startLive();
                $('loadBtn').style.display = 'none';
                $('stopBtn').style.display = 'block';
                $('liveBadge').style.display = 'inline-block';
                $('analyzeBtn').disabled = false;
                showStatus('‚úÖ –ì—Ä–∞—Ñ–∏–∫ –∑–∞–ø—É—â–µ–Ω. Live –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ...');

            } catch(e) {
                showStatus(e.message, true);
                $('loadBtn').disabled = false;
            }
        };

        $('stopBtn').onclick = () => {
            clearInterval(updateTimer);
            $('stopBtn').style.display = 'none';
            $('loadBtn').style.display = 'block';
            $('loadBtn').disabled = false;
            $('liveBadge').style.display = 'none';
            showStatus('‚è∏ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ.');
        };

        // 2. LIVE UPDATE ENGINE (Using 1-minute candles)
        function startLive() {
            const tick = async () => {
                console.log("Tick: fetching 1-min candles...");
                try {
                    // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –º–∏–Ω—É—Ç–∫–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å
                    const now = new Date();
                    const from = new Date(now.getTime() - 2 * 60 * 60 * 1000).toISOString().split('T')[0];
                    
                    const res = await fetch('/api/proxy', {
                        method: 'POST',
                        headers: {'Content-Type':'application/json'},
                        body: JSON.stringify({
                            username: $('user').value, password: $('pass').value,
                            from: from, till: now.toISOString().split('T')[0], 
                            interval: 1 // –í–ê–ñ–ù–û: –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º 1-–º–∏–Ω—É—Ç–Ω—ã–µ —Å–≤–µ—á–∏
                        })
                    });
                    const data = await res.json();
                    if (data.candles && data.candles.data.length > 0) {
                        processMinuteData(data.candles);
                    }
                } catch(e) { console.error("Live update error", e); }
            };
            
            tick(); // –°—Ä–∞–∑—É
            updateTimer = setInterval(tick, 60000); // –ö–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
        }

        // 3. AGGREGATOR: Convert 1-min candles -> Current Hour Candle
        function processMinuteData(candlesData) {
            const cols = candlesData.columns;
            const rows = candlesData.data;
            const idx = { o: cols.indexOf('open'), c: cols.indexOf('close'), h: cols.indexOf('high'), l: cols.indexOf('low'), v: cols.indexOf('volume'), t: cols.indexOf('begin') };

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞—á–∞–ª–æ —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Å–∞ –≤ UTC
            const nowUTCTs = Math.floor(Date.now() / 1000);
            const currentHourStartTs = Math.floor(nowUTCTs / 3600) * 3600;

            // –ü–∞—Ä—Å–∏–º –º–∏–Ω—É—Ç–Ω—ã–µ —Å–≤–µ—á–∏
            const minuteCandles = rows.map(r => {
                const time = Math.floor(new Date(r[idx.t].replace(' ','T')+'+03:00')/1000);
                return {
                    time: time,
                    open: +r[idx.o], high: +r[idx.h], low: +r[idx.l], close: +r[idx.c], volume: +r[idx.v]
                };
            });

            // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ, —á—Ç–æ –æ—Ç–Ω–æ—Å—è—Ç—Å—è –∫ —Ç–µ–∫—É—â–µ–º—É —á–∞—Å—É
            const currentHourMinutes = minuteCandles.filter(c => c.time >= currentHourStartTs);

            if (currentHourMinutes.length === 0) return; // –¢–æ—Ä–≥–æ–≤ –Ω–µ—Ç –≤–Ω—É—Ç—Ä–∏ —á–∞—Å–∞

            // –°–æ–±–∏—Ä–∞–µ–º —á–∞—Å–æ–≤—É—é —Å–≤–µ—á—É –≤—Ä—É—á–Ω—É—é
            const liveHourCandle = {
                time: currentHourStartTs,
                open: currentHourMinutes[0].open, // –û—Ç–∫—Ä—ã—Ç–∏–µ –ø–µ—Ä–≤–æ–π –º–∏–Ω—É—Ç–∫–∏
                high: Math.max(...currentHourMinutes.map(c => c.high)),
                low: Math.min(...currentHourMinutes.map(c => c.low)),
                close: currentHourMinutes[currentHourMinutes.length - 1].close, // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–π –º–∏–Ω—É—Ç–∫–∏
                volume: currentHourMinutes.reduce((sum, c) => sum + c.volume, 0)
            };

            // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫
            updateChartWithLiveCandle(liveHourCandle);
        }

        function updateChartWithLiveCandle(newCandle) {
            if (!candleSeries) return;

            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–ª–∏ –¥–æ–±–∞–≤–ª—è–µ–º —Å–≤–µ—á—É –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ
            candleSeries.update(newCandle);

            // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –º–∞—Å—Å–∏–≤ (–¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏ AI)
            // –ï—Å–ª–∏ –≤—Ä–µ–º—è —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–≤–µ—á–æ–π (—ç—Ç–æ –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ —á–∞—Å), –æ–±–Ω–æ–≤–ª—è–µ–º
            if (candles.length > 0 && candles[candles.length-1].time === newCandle.time) {
                candles[candles.length-1] = newCandle;
            } 
            // –ï—Å–ª–∏ –≤—Ä–µ–º—è –Ω–æ–≤–æ–µ (–Ω–∞—Å—Ç—É–ø–∏–ª –Ω–æ–≤—ã–π —á–∞—Å), –¥–æ–±–∞–≤–ª—è–µ–º
            else if (newCandle.time > (candles.length > 0 ? candles[candles.length-1].time : 0)) {
                candles.push(newCandle);
                // –ü–µ—Ä–µ—Å—á–µ—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ –ø—Ä–∏ –ø–æ—è–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ–π —Å–≤–µ—á–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏ –ø–∞–Ω–µ–ª–∏)
                indicators.rsi = calcRSI(candles);
                indicators.sma = calcSMA(candles);
            }

            updateStats(newCandle);
        }

        function initChart() {
            if(chart) chart.remove();
            chart = LightweightCharts.createChart('chart', { 
                layout: { backgroundColor: '#1e222d', textColor: '#d1d4dc' }, 
                grid: { vertLines: { color: '#2a2e39' }, horzLines: { color: '#2a2e39' } }, 
                timeScale: { timeVisible: true } 
            });
            candleSeries = chart.addCandlestickSeries({ upColor: '#26a69a', downColor: '#ef5350', borderUpColor: '#26a69a', borderDownColor: '#ef5350' });
            candleSeries.setData(candles);
            chart.timeScale().fitContent();
            window.addEventListener('resize', () => chart.applyOptions({width: $('chart').clientWidth}));
        }

        function updateStats(liveCandle) {
            if(!candles.length) return;
            
            // –ë–µ—Ä–µ–º –ª–∏–±–æ –ø–æ—Å–ª–µ–¥–Ω—é—é –ø–æ–ª–Ω—É—é, –ª–∏–±–æ –∂–∏–≤—É—é
            const last = liveCandle || candles[candles.length-1];
            const prev = candles.length > 1 ? candles[candles.length-2] : last;
            const diff = last.close - prev.close;
            const rsiVal = indicators.rsi[indicators.rsi.length-1];
            
            $('sPrice').innerText = last.close.toFixed(2);
            $('sPrice').style.color = diff >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
            
            $('sHigh').innerText = last.high.toFixed(2);
            $('sLow').innerText = last.low.toFixed(2);
            $('sRsi').innerText = rsiVal ? rsiVal.toFixed(1) : '--';
        }

        // 4. AI ANALYSIS (Same as before)
        $('analyzeBtn').onclick = async () => {
            const key = $('aiKey').value;
            if(!key) return alert("–í–≤–µ–¥–∏—Ç–µ DeepSeek API Key");

            const btn = $('analyzeBtn');
            const container = $('aiResultContainer');
            btn.disabled = true;
            btn.innerHTML = '<div class="loader"></div> –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é...';
            container.style.display = 'none';

            try {
                // Fetch News
                const newsRes = await fetch('/api/proxy', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({action:'getNews'}) });
                const newsData = await newsRes.json();
                
                // Prepare Data
                const last = candles[candles.length-1];
                const sma = indicators.sma;
                const rsi = indicators.rsi;
                
                const systemPrompt = `–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç—Ä–µ–π–¥–µ—Ä. –í–µ—Ä–Ω–∏ –∞–Ω–∞–ª–∏–∑ –°–¢–†–û–ì–û –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ.
{
  "signal": "LONG –∏–ª–∏ SHORT –∏–ª–∏ NEUTRAL",
  "entry_price": —á–∏—Å–ª–æ,
  "take_profit": —á–∏—Å–ª–æ,
  "stop_loss": —á–∏—Å–ª–æ,
  "confidence": —á–∏—Å–ª–æ (0-100),
  "summary": "–ö—Ä–∞—Ç–∫–∏–π –≤—ã–≤–æ–¥",
  "technical": "–¢–µ—Ö–∞–Ω–∞–ª–∏–∑",
  "fundamental": "–§—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª",
  "risks": "–†–∏—Å–∫–∏"
}`;

                const userPrompt = `–¢–ò–ö–ï–†: SiH6. –¶–ï–ù–ê: ${last.close}. RSI: ${rsi[rsi.length-1]?.toFixed(1)}. SMA20: ${sma[sma.length-1]?.toFixed(1)}.
–ù–û–í–û–°–¢–ò: ${newsData.news}
–î–∞–π –ø—Ä–æ–≥–Ω–æ–∑.`;

                const aiRes = await fetch('/api/proxy', {
                    method: 'POST',
                    headers: {'Content-Type':'application/json', 'Authorization': `Bearer ${key}`},
                    body: JSON.stringify({ model: 'deepseek-chat', messages: [{role: 'system', content: systemPrompt}, {role: 'user', content: userPrompt}], temperature: 0.1 })
                });
                const aiData = await aiRes.json();
                if(aiData.error) throw new Error(aiData.error.message);

                const content = aiData.choices[0].message.content;
                let parsed;
                try {
                    let cleanContent = content.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                    parsed = JSON.parse(cleanContent);
                } catch (e) {
                    throw new Error("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç JSON –æ—Ç –ò–ò");
                }

                renderAnalysis(parsed, container);
                drawLevels(parsed);

            } catch(e) {
                container.style.display = 'block';
                container.innerHTML = `<div style="color:var(--accent-red);">–û—à–∏–±–∫–∞: ${e.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.innerText = '–ü–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–≥–Ω–æ–∑ –∏ —É—Ä–æ–≤–Ω–∏';
            }
        };

        function renderAnalysis(data, container) {
            const signalClass = data.signal === 'LONG' ? 'signal-long' : (data.signal === 'SHORT' ? 'signal-short' : 'signal-neutral');
            container.innerHTML = `
                <div class="ai-header">
                    <h2 style="margin:0; font-size:18px;">–°–∏–≥–Ω–∞–ª: <span class="signal-badge ${signalClass}">${data.signal}</span></h2>
                    <div style="font-size:12px; color:var(--text-muted);">–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${data.confidence}%</div>
                </div>
                <div class="levels-grid">
                    <div class="level-box"><div style="color:var(--text-muted); font-size:11px;">–í–•–û–î</div><div class="level-val entry-color">${data.entry_price}</div></div>
                    <div class="level-box"><div style="color:var(--text-muted); font-size:11px;">TAKE PROFIT</div><div class="level-val tp-color">${data.take_profit}</div></div>
                    <div class="level-box"><div style="color:var(--text-muted); font-size:11px;">STOP LOSS</div><div class="level-val sl-color">${data.stop_loss}</div></div>
                </div>
                <div style="background: rgba(255,255,255,0.05); padding:10px; border-radius:6px; margin-bottom:15px;">
                    <b>‚ö° –°—É—Ç—å:</b> ${data.summary}
                </div>
                <div class="analysis-content">
                    <h3>üìâ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑</h3><p>${data.technical.replace(/\n/g, '<br>')}</p>
                    <h3>üì∞ –§—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª</h3><p>${data.fundamental.replace(/\n/g, '<br>')}</p>
                    <h3>‚ö†Ô∏è –†–∏—Å–∫–∏</h3><p>${data.risks.replace(/\n/g, '<br>')}</p>
                </div>
            `;
            container.style.display = 'block';
        }

        function drawLevels(data) {
            if (!candleSeries) return;
            priceLines.forEach(line => candleSeries.removePriceLine(line));
            priceLines = [];
            const createLine = (price, color, title) => {
                if(!price) return;
                const line = candleSeries.createPriceLine({ price: price, color: color, lineWidth: 2, lineStyle: 2, axisLabelVisible: true, title: title });
                priceLines.push(line);
            };
            createLine(data.entry_price, '#2962ff', 'Entry');
            createLine(data.take_profit, '#26a69a', 'TP');
            createLine(data.stop_loss, '#ef5350', 'SL');
        }
    </script>
</body>
</html>
