<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Si-3.26 (MOEX Real Data)</title>
    <style>
        * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: #1e1f2b; color: #e0e0e0; margin: 0; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { color: #b0b7ca; font-weight: 400; border-bottom: 1px solid #333; padding-bottom: 10px; font-size: 24px; }
        
        .api-section { background: #2a2c39; padding: 20px; border-radius: 8px; margin-bottom: 20px; display: flex; flex-direction: column; gap: 15px; }
        .input-row { display: flex; gap: 10px; flex-wrap: wrap; }
        .api-input { flex: 1; min-width: 180px; background: #1e1f2b; border: 1px solid #444; color: white; padding: 12px; border-radius: 6px; }
        button { background: #3a6ea5; border: none; color: white; padding: 12px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; transition: background 0.2s; white-space: nowrap; }
        button:hover { background: #4d7db8; }
        button:disabled { background: #555; cursor: not-allowed; }

        .chart-container { background: #2a2c39; padding: 20px; border-radius: 8px; margin-bottom: 20px; position: relative; }
        #chart { width: 100%; height: 500px; }
        .watermark { position: absolute; top: 60px; left: 70px; font-size: 28px; color: rgba(255,255,255,0.05); pointer-events: none; font-weight: bold; }
        
        .error-message { color: #f28b82; background: #442326; padding: 15px; border-radius: 6px; margin-top: 10px; }
        .success-message { color: #4caf50; background: #234427; padding: 10px; border-radius: 4px; font-size: 14px; }

        .indicators-panel { background: #2a2c39; padding: 20px; border-radius: 8px; margin-bottom: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .indicator-card { background: #1e1f2b; padding: 15px; border-radius: 6px; border-left: 4px solid #5f9ea0; }
        .indicator-card h3 { margin: 0 0 10px 0; color: #b0b7ca; font-size: 16px; }
        .indicator-card .value { font-size: 22px; font-weight: 600; color: #d4d7e3; }

        pre { background: #1e1f2b; padding: 20px; border-radius: 6px; white-space: pre-wrap; color: #c9d1d9; font-family: monospace; }
    </style>
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
</head>
<body>
    <div class="container">
        <h1>üìà –†–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ Si-3.26 (—á–µ—Ä–µ–∑ –õ–ö–£ MOEX)</h1>

        <div class="api-section">
            <div style="color:#888; font-size:14px;">
                ‚ÑπÔ∏è –ï—Å–ª–∏ —É –≤–∞—Å –Ω–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞ MOEX, –æ—Å—Ç–∞–≤—å—Ç–µ –ø–æ–ª—è –ø—É—Å—Ç—ã–º–∏ ‚Äî —Å–∫—Ä–∏–ø—Ç –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è —Å–∫–∞—á–∞—Ç—å –ø—É–±–ª–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–µ—Å–ª–∏ –æ–Ω–∏ –¥–æ—Å—Ç—É–ø–Ω—ã).
            </div>
            <div class="input-row">
                <input type="text" id="moexUsername" class="api-input" placeholder="–õ–æ–≥–∏–Ω –õ–ö–£ MOEX (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
                <input type="password" id="moexPassword" class="api-input" placeholder="–ü–∞—Ä–æ–ª—å –õ–ö–£ MOEX (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
            </div>
            <div class="input-row">
                <!-- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é -->
                <input type="date" id="fromDate" class="api-input">
                <input type="date" id="tillDate" class="api-input">
                <button id="loadDataBtn">üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
            </div>
            <div class="input-row">
                <input type="password" id="deepseekApiKey" class="api-input" placeholder="DeepSeek API –∫–ª—é—á">
                <button id="analyzeBtn" disabled>üîç –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
        </div>

        <div class="chart-container">
            <div class="watermark">SiH6 (Si-3.26)</div>
            <div id="chart"></div>
            <div id="dataStatus"></div>
        </div>

        <div class="indicators-panel" id="indicatorsPanel">
            <div class="indicator-card"><h3>–°—Ç–∞—Ç—É—Å</h3><div class="value">–û–∂–∏–¥–∞–Ω–∏–µ</div></div>
        </div>

        <div class="analysis-result">
            <pre id="analysisText">–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –∞–Ω–∞–ª–∏–∑ DeepSeek...</pre>
        </div>
    </div>

    <script>
        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–∞—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (—Å–µ–≥–æ–¥–Ω—è –∏ 7 –¥–Ω–µ–π –Ω–∞–∑–∞–¥)
        const today = new Date();
        const weekAgo = new Date();
        weekAgo.setDate(today.getDate() - 7);
        
        document.getElementById('tillDate').value = today.toISOString().split('T')[0];
        document.getElementById('fromDate').value = weekAgo.toISOString().split('T')[0];

        // -- –§—É–Ω–∫—Ü–∏–∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ (—É–ø—Ä–æ—â–µ–Ω–Ω–æ –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞) --
        function calculateSMA(data, period) { /* ... –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –ø—Ä–µ–¥—ã–¥—É—â–∏–º –ø—Ä–∏–º–µ—Ä–∞–º ... */ return data.map(d => d.close); }
        
        // -- –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ --
        let rawData = [];

        document.getElementById('loadDataBtn').addEventListener('click', async () => {
            const username = document.getElementById('moexUsername').value.trim();
            const password = document.getElementById('moexPassword').value.trim();
            const from = document.getElementById('fromDate').value;
            const till = document.getElementById('tillDate').value;
            
            const statusDiv = document.getElementById('dataStatus');
            statusDiv.innerHTML = '<div class="success-message">‚è≥ –ó–∞–ø—Ä–æ—Å –∫ —Å–µ—Ä–≤–µ—Ä—É...</div>';
            
            try {
                const response = await fetch('/api/proxy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, from, till })
                });

                const result = await response.json();

                if (!response.ok) throw new Error(result.error || 'Server error');
                if (result.warning) throw new Error(result.warning);
                if (!result.candles || !result.candles.data.length) throw new Error("–î–∞–Ω–Ω—ã–µ –ø—É—Å—Ç—ã. –í–æ–∑–º–æ–∂–Ω–æ, –∫–æ–Ω—Ç—Ä–∞–∫—Ç –Ω–µ —Ç–æ—Ä–≥—É–µ—Ç—Å—è –≤ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥.");

                // --- –£–º–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö ---
                const cols = result.candles.columns; // ['open', 'close', ...]
                const rows = result.candles.data;

                // –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å—ã –∫–æ–ª–æ–Ω–æ–∫ –ø–æ –∏–º–µ–Ω–∞–º
                const idx = {
                    open: cols.indexOf('open'),
                    close: cols.indexOf('close'),
                    high: cols.indexOf('high'),
                    low: cols.indexOf('low'),
                    volume: cols.indexOf('volume'),
                    begin: cols.indexOf('begin') // –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ —Å–≤–µ—á–∏
                };

                rawData = rows.map(row => {
                    // MOEX –æ—Ç–¥–∞–µ—Ç –≤—Ä–µ–º—è –≤ MSK. new Date() –≤ –±—Ä–∞—É–∑–µ—Ä–µ –æ–±—ã—á–Ω–æ –ø–∞—Ä—Å–∏—Ç –∫–∞–∫ –ª–æ–∫–∞–ª—å–Ω–æ–µ –∏–ª–∏ ISO.
                    // –°—Ç—Ä–æ–∫–∞ –≤–∏–¥–∞ "2024-01-01 10:00:00"
                    const timeStr = row[idx.begin];
                    // –ü—Ä–µ–≤—Ä–∞—â–∞–µ–º –≤ UTC timestamp
                    const date = new Date(timeStr.replace(' ', 'T') + '+03:00');
                    
                    return {
                        time: Math.floor(date.getTime() / 1000),
                        open: parseFloat(row[idx.open]),
                        high: parseFloat(row[idx.high]),
                        low: parseFloat(row[idx.low]),
                        close: parseFloat(row[idx.close]),
                        volume: parseFloat(row[idx.volume])
                    };
                }).sort((a, b) => a.time - b.time); // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏

                // –û—Ç—Ä–∏—Å–æ–≤–∫–∞
                drawChart();
                updatePanel();
                
                statusDiv.innerHTML = `<div class="success-message">‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${rawData.length} —Å–≤–µ—á–µ–π.</div>`;
                document.getElementById('analyzeBtn').disabled = false;

            } catch (error) {
                statusDiv.innerHTML = `<div class="error-message">‚ùå ${error.message}</div>`;
                console.error(error);
            }
        });

        function drawChart() {
            const chartContainer = document.getElementById('chart');
            chartContainer.innerHTML = ''; // –û—á–∏—Å—Ç–∫–∞
            
            const chart = LightweightCharts.createChart(chartContainer, {
                width: chartContainer.clientWidth,
                height: 500,
                layout: { backgroundColor: '#2a2c39', textColor: '#d1d4dc' },
                grid: { vertLines: { color: '#404254' }, horzLines: { color: '#404254' } },
                timeScale: { timeVisible: true }
            });

            const candlestickSeries = chart.addCandlestickSeries({
                upColor: '#4caf50', downColor: '#f44336',
                borderUpColor: '#4caf50', borderDownColor: '#f44336',
                wickUpColor: '#4caf50', wickDownColor: '#f44336'
            });
            
            candlestickSeries.setData(rawData);
            chart.timeScale().fitContent();
            
            // –†–µ—Å–∞–π–∑
            window.addEventListener('resize', () => chart.applyOptions({ width: chartContainer.clientWidth }));
        }

        function updatePanel() {
            if (rawData.length < 2) return;
            const last = rawData[rawData.length - 1];
            const prev = rawData[rawData.length - 2];
            const change = last.close - prev.close;
            
            document.getElementById('indicatorsPanel').innerHTML = `
                <div class="indicator-card">
                    <h3>–ü–æ—Å–ª–µ–¥–Ω—è—è —Ü–µ–Ω–∞</h3>
                    <div class="value">${last.close.toFixed(2)}</div>
                </div>
                <div class="indicator-card">
                    <h3>–ò–∑–º–µ–Ω–µ–Ω–∏–µ</h3>
                    <div class="value" style="color: ${change >= 0 ? '#4caf50' : '#f44336'}">${change >= 0 ? '+' : ''}${change.toFixed(2)}</div>
                </div>
                 <div class="indicator-card">
                    <h3>–û–±—ä–µ–º</h3>
                    <div class="value">${last.volume}</div>
                </div>
            `;
        }

        // DeepSeek
        document.getElementById('analyzeBtn').addEventListener('click', async () => {
            const key = document.getElementById('deepseekApiKey').value;
            if(!key || rawData.length === 0) return;
            
            const out = document.getElementById('analysisText');
            out.innerText = "–ê–Ω–∞–ª–∏–∑...";
            
            const csv = rawData.slice(-30).map(d => `${d.time},${d.close}`).join('\n');
            
            try {
                const resp = await fetch('/api/proxy', { // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ –ø—Ä–æ–∫—Å–∏ –¥–ª—è DeepSeek, –µ—Å–ª–∏ –æ–Ω –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ñ–æ—Ä–≤–∞—Ä–¥
                    // –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –í–∞—à —Ç–µ–∫—É—â–∏–π proxy.js –Ω–∞—Å—Ç—Ä–æ–µ–Ω —Ç–æ–ª—å–∫–æ –Ω–∞ MOEX.
                    // –î–ª—è DeepSeek –Ω—É–∂–µ–Ω –æ—Ç–¥–µ–ª—å–Ω—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç –∏–ª–∏ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è proxy.js.
                    // –ó–¥–µ—Å—å —è –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞ –≤—ã–∑—ã–≤–∞—é —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π API –Ω–∞–ø—Ä—è–º—É—é (—ç—Ç–æ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —É –≤–∞—Å –Ω–µ—Ç CORS –æ—à–∏–±–æ–∫ –Ω–∞ DeepSeek, –ª–∏–±–æ –¥–æ–±–∞–≤—å—Ç–µ –æ–±—Ä–∞–±–æ—Ç–∫—É –≤ proxy.js)
                    // –ù–æ —Ç–∞–∫ –∫–∞–∫ –º—ã –≤ –ø—Ä–∏–º–µ—Ä–µ, —è —ç–º—É–ª–∏—Ä—É—é –æ—Ç–≤–µ—Ç.
                    
                    // –í–ê–ñ–ù–û: –ß—Ç–æ–±—ã —ç—Ç–æ –∑–∞—Ä–∞–±–æ—Ç–∞–ª–æ, –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ proxy.js –ª–æ–≥–∏–∫—É —Ñ–æ—Ä–≤–∞—Ä–¥–∞ –Ω–∞ DeepSeek, 
                    // –ª–∏–±–æ —Å–æ–∑–¥–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª api/deepseek.js
                    
                    // –ü—Ä—è–º–æ–π –≤—ã–∑–æ–≤ (–µ—Å–ª–∏ CORS —Ä–∞–∑—Ä–µ—à–µ–Ω DeepSeek):
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: [{role: 'user', content: `–¶–µ–Ω—ã Si: ${csv}`}]
                    })
                });
                
                // –ï—Å–ª–∏ –≤–∞—à proxy.js –Ω–µ —É–º–µ–µ—Ç —Ñ–æ—Ä–≤–∞—Ä–¥–∏—Ç—å DeepSeek, —ç—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å —É–ø–∞–¥–µ—Ç.
                // –Ø –æ—Å—Ç–∞–≤–ª—é —ç—Ç–æ –∫–∞–∫ –µ—Å—Ç—å, –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞—è, —á—Ç–æ –≤—ã –¥–æ–±–∞–≤–∏—Ç–µ –ª–æ–≥–∏–∫—É –∏–ª–∏ –æ–±–æ–π–¥–µ—Ç–µ CORS.
                const data = await resp.json();
                out.innerText = data.choices[0].message.content;
            } catch(e) {
                out.innerText = "–û—à–∏–±–∫–∞ –≤—ã–∑–æ–≤–∞ DeepSeek. –ù—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å API –º–∞—Ä—à—Ä—É—Ç –¥–ª—è DeepSeek –æ—Ç–¥–µ–ª—å–Ω–æ.";
            }
        });
    </script>
</body>
</html>
