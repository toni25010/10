<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Si-3.26 PRO Terminal</title>
    <style>
        :root {
            --bg-main: #131722;
            --bg-panel: #1e222d;
            --bg-card: #2a2e39;
            --text-main: #d1d4dc;
            --text-muted: #787b86;
            --accent-green: #26a69a;
            --accent-red: #ef5350;
            --accent-blue: #2962ff;
        }
        
        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        body { background: var(--bg-main); color: var(--text-main); margin: 0; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        
        h1 { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--bg-card); padding-bottom: 15px; margin-bottom: 20px; }
        .live-badge { background: var(--accent-red); padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        .grid-2 { display: grid; grid-template-columns: 1fr 380px; gap: 20px; }
        @media (max-width: 1000px) { .grid-2 { grid-template-columns: 1fr; } }
        
        .panel { background: var(--bg-panel); border-radius: 8px; padding: 20px; margin-bottom: 20px; }
        
        .controls-row { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        input { background: var(--bg-main); border: 1px solid var(--bg-card); color: var(--text-main); padding: 10px; border-radius: 6px; flex: 1; min-width: 120px; }
        button { background: var(--accent-blue); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; }
        button:hover { opacity: 0.9; }
        button:disabled { background: #444; cursor: not-allowed; }
        .btn-analyze { background: linear-gradient(45deg, #2e7d32, #43a047); width: 100%; margin-top: 10px; font-size: 16px; padding: 12px; }
        
        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 20px; }
        .stat-card { background: var(--bg-panel); padding: 12px; border-radius: 6px; text-align: center; border: 1px solid var(--bg-card); }
        .stat-label { font-size: 11px; color: var(--text-muted); margin-bottom: 4px; text-transform: uppercase; }
        .stat-value { font-size: 16px; font-weight: 600; }

        #chart { width: 100%; height: 450px; background: var(--bg-panel); border-radius: 8px; }

        /* AI Card */
        .ai-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .signal-badge { padding: 5px 15px; border-radius: 20px; font-weight: bold; text-transform: uppercase; font-size: 14px; }
        .signal-long { background: rgba(38, 166, 154, 0.2); color: var(--accent-green); border: 1px solid var(--accent-green); }
        .signal-short { background: rgba(239, 83, 80, 0.2); color: var(--accent-red); border: 1px solid var(--accent-red); }
        .signal-neutral { background: rgba(41, 98, 255, 0.2); color: var(--accent-blue); border: 1px solid var(--accent-blue); }

        .levels-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; text-align: center; }
        .level-box { padding: 10px; border-radius: 6px; background: var(--bg-card); }
        .level-val { font-size: 18px; font-weight: bold; margin-top: 5px; }
        .tp-color { color: var(--accent-green); }
        .sl-color { color: var(--accent-red); }
        .entry-color { color: var(--accent-blue); }

        .analysis-content { background: var(--bg-main); padding: 15px; border-radius: 6px; line-height: 1.6; font-size: 13px; max-height: 450px; overflow-y: auto; }
        .analysis-content h3 { color: var(--text-main); margin-top: 15px; margin-bottom: 5px; font-size: 14px; border-bottom: 1px solid #333; padding-bottom: 5px; }
        
        .loader { display: inline-block; width: 20px; height: 20px; border: 2px solid #fff; border-radius: 50%; border-top-color: transparent; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .status { font-size: 12px; margin-top: 5px; padding: 8px; border-radius: 4px; display: none; }
    </style>
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
</head>
<body>
    <div class="container">
        <h1>
            <span>üìà Si-3.26 Quant Terminal</span>
            <span id="liveBadge" style="display:none" class="live-badge">LIVE DATA</span>
        </h1>

        <div class="stats-grid" id="statsGrid">
            <div class="stat-card"><div class="stat-label">–¶–µ–Ω–∞</div><div class="stat-value" id="sPrice">--</div></div>
            <div class="stat-card"><div class="stat-label">–¢—Ä–µ–Ω–¥ (1—á)</div><div class="stat-value" id="sTrend">--</div></div>
            <div class="stat-card"><div class="stat-label">ATR (Vol)</div><div class="stat-value" id="sAtr">--</div></div>
            <div class="stat-card"><div class="stat-label">RSI</div><div class="stat-value" id="sRsi">--</div></div>
            <div class="stat-card"><div class="stat-label">MACD</div><div class="stat-value" id="sMacd">--</div></div>
        </div>

        <div class="grid-2">
            <div>
                <div class="panel">
                    <div class="controls-row">
                        <input type="text" id="user" placeholder="MOEX Login">
                        <input type="password" id="pass" placeholder="MOEX Password">
                    </div>
                    <div class="controls-row">
                        <input type="date" id="from">
                        <input type="date" id="to">
                        <button id="loadBtn">‚ñ∂ –ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
                        <button id="stopBtn" style="display:none; background:#c62828;">‚ñ† –°—Ç–æ–ø</button>
                    </div>
                    <div class="status" id="statusBox"></div>
                </div>
                <div id="chart"></div>
            </div>

            <div class="panel" style="height: fit-content;">
                <h2 style="margin-top:0; font-size:18px;">ü§ñ –ü—Ä–æ–≥–Ω–æ–∑–Ω—ã–π –º–æ–¥—É–ª—å</h2>
                <input type="password" id="aiKey" placeholder="DeepSeek API Key" style="width:100%; margin-bottom:10px;">
                <button id="analyzeBtn" disabled class="btn-analyze">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–æ—Ä–≥–æ–≤—ã–π —Å–∏–≥–Ω–∞–ª</button>
                
                <div id="aiResultContainer" style="margin-top:20px; display:none;"></div>
            </div>
        </div>
    </div>

    <script>
        // --- Setup ---
        document.getElementById('to').value = new Date().toISOString().split('T')[0];
        document.getElementById('from').value = new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

        let chart = null, candleSeries = null, smaLineSeries = null;
        let candles = [], indicators = {};
        let updateTimer = null;
        let priceLines = []; 

        // --- Advanced Indicator Calculations ---

        // SMA
        const calcSMA = (d, period) => {
            let sma = [];
            for (let i = 0; i < d.length; i++) {
                if (i < period - 1) { sma.push(null); continue; }
                let sum = 0;
                for (let j = i - period + 1; j <= i; j++) sum += d[j].close;
                sma.push(sum / period);
            }
            return sma;
        };

        // RSI
        const calcRSI = (d, period = 14) => {
            let rsi = [];
            let gains = 0, losses = 0;
            for (let i = 1; i <= period; i++) {
                let diff = d[i].close - d[i-1].close;
                if (diff > 0) gains += diff; else losses -= diff;
            }
            let avgGain = gains / period;
            let avgLoss = losses / period;

            for (let i = 0; i < d.length; i++) {
                if (i < period) { rsi.push(null); continue; }
                if (i > period) {
                    let diff = d[i].close - d[i-1].close;
                    avgGain = (avgGain * (period - 1) + (diff > 0 ? diff : 0)) / period;
                    avgLoss = (avgLoss * (period - 1) + (diff < 0 ? -diff : 0)) / period;
                }
                if (avgLoss === 0) rsi.push(100);
                else rsi.push(100 - (100 / (1 + avgGain / avgLoss)));
            }
            return rsi;
        };

        // EMA (–¥–ª—è MACD)
        const calcEMA = (d, period) => {
            let ema = [];
            let k = 2 / (period + 1);
            let sum = 0;
            
            // Initial SMA
            for(let i=0; i<period; i++) sum += d[i].close;
            ema[period-1] = sum / period;

            for(let i=period; i<d.length; i++) {
                ema[i] = d[i].close * k + ema[i-1] * (1-k);
            }
            return ema;
        };

        // MACD
        const calcMACD = (d) => {
            const ema12 = calcEMA(d, 12);
            const ema26 = calcEMA(d, 26);
            let macdLine = [], signalLine = [], histogram = [];

            // Calculate MACD Line
            for(let i=0; i<d.length; i++) {
                if(ema26[i]) macdLine[i] = ema12[i] - ema26[i];
                else macdLine[i] = null;
            }

            // Calculate Signal Line (9-period EMA of MACD)
            // Simple approximation for signal line using SMA for first points
            // Note: Proper EMA of MACD needs careful handling, simplified here for AI context
            let validMacd = macdLine.filter(x => x !== null);
            let sigEma = [];
            let k = 2/(9+1);
            // Start SMA
            let sum = 0;
            let startIdx = d.length - validMacd.length;
            
            // Find first valid MACD index
            let firstValid = macdLine.findIndex(x => x !== null);
            
            // Fill nulls
            for(let i=0; i<firstValid+8; i++) signalLine.push(null);
            
            // Start Signal calc
            for(let i=firstValid+8; i<d.length; i++) {
                if(i === firstValid+8) {
                    // Simple start
                    signalLine.push(macdLine[i]); 
                } else {
                    let prev = signalLine[signalLine.length-1];
                    signalLine.push(macdLine[i] * k + prev * (1-k));
                }
            }

            for(let i=0; i<d.length; i++) {
                if(macdLine[i] && signalLine[i]) histogram.push(macdLine[i] - signalLine[i]);
                else histogram.push(null);
            }

            return { macdLine, signalLine, histogram };
        };

        // ATR (Average True Range) - Volatility
        const calcATR = (d, period = 14) => {
            let tr = [];
            for(let i=0; i<d.length; i++) {
                if(i===0) { tr.push(d[i].high - d[i].low); continue; }
                let high = d[i].high;
                let low = d[i].low;
                let prevClose = d[i-1].close;
                let trueHigh = Math.max(high, prevClose);
                let trueLow = Math.min(low, prevClose);
                tr.push(trueHigh - trueLow);
            }
            
            // SMA of TR for ATR
            let atr = [];
            for(let i=0; i<d.length; i++) {
                if(i < period - 1) { atr.push(null); continue; }
                let sum = 0;
                for(let j=i-period+1; j<=i; j++) sum += tr[j];
                atr.push(sum / period);
            }
            return atr;
        };

        // Trend Structure Analyzer
        const analyzeTrend = (d) => {
            if(d.length < 5) return "–ù/–î";
            const last5 = d.slice(-5);
            const highs = last5.map(c => c.high);
            const lows = last5.map(c => c.low);
            
            let hh = true, ll = true;
            for(let i=1; i<5; i++) {
                if(highs[i] < highs[i-1]) hh = false;
                if(lows[i] > lows[i-1]) ll = false;
            }
            
            if(hh && !ll) return "–ë—ã—á–∏–π (Higher Highs)";
            if(ll && !hh) return "–ú–µ–¥–≤–µ–∂–∏–π (Lower Lows)";
            if(!hh && !ll) return "–ë–æ–∫–æ–≤–∏–∫ / –®—É–º";
            return "–°–º–µ—à–∞–Ω–Ω—ã–π";
        };

        // --- Core Logic ---
        const $ = id => document.getElementById(id);
        const showStatus = (msg, isError=false) => {
            const el = $('statusBox');
            el.style.display = 'block';
            el.className = 'status ' + (isError ? 'status-err' : 'status-ok');
            el.innerText = msg;
        };

        // 1. INITIAL LOAD
        $('loadBtn').onclick = async () => {
            $('loadBtn').disabled = true;
            showStatus('‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...');
            try {
                const res = await fetch('/api/proxy', {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({
                        username: $('user').value, password: $('pass').value,
                        from: $('from').value, till: $('to').value, 
                        interval: 60
                    })
                });
                const data = await res.json();
                if (!res.ok || data.warning) throw new Error(data.error || data.warning);

                const cols = data.candles.columns;
                const idx = { o: cols.indexOf('open'), c: cols.indexOf('close'), h: cols.indexOf('high'), l: cols.indexOf('low'), v: cols.indexOf('volume'), t: cols.indexOf('begin') };
                
                candles = data.candles.data.map(r => ({
                    time: Math.floor(new Date(r[idx.t].replace(' ','T')+'+03:00')/1000),
                    open: +r[idx.o], high: +r[idx.h], low: +r[idx.l], close: +r[idx.c], volume: +r[idx.v]
                })).sort((a,b)=>a.time-b.time);

                updateIndicators();
                initChart();
                updateStats();
                
                startLive();
                $('loadBtn').style.display = 'none';
                $('stopBtn').style.display = 'block';
                $('liveBadge').style.display = 'inline-block';
                $('analyzeBtn').disabled = false;
                showStatus('‚úÖ –ó–∞–ø—É—â–µ–Ω–æ.');

            } catch(e) {
                showStatus(e.message, true);
                $('loadBtn').disabled = false;
            }
        };

        $('stopBtn').onclick = () => {
            clearInterval(updateTimer);
            $('stopBtn').style.display = 'none';
            $('loadBtn').style.display = 'block';
            $('loadBtn').disabled = false;
            $('liveBadge').style.display = 'none';
        };

        // 2. LIVE UPDATE (1-min aggregation)
        function startLive() {
            const tick = async () => {
                try {
                    const now = new Date();
                    const from = new Date(now.getTime() - 2 * 60 * 60 * 1000).toISOString().split('T')[0];
                    const res = await fetch('/api/proxy', {
                        method: 'POST',
                        headers: {'Content-Type':'application/json'},
                        body: JSON.stringify({
                            username: $('user').value, password: $('pass').value,
                            from: from, till: now.toISOString().split('T')[0], 
                            interval: 1
                        })
                    });
                    const data = await res.json();
                    if (data.candles && data.candles.data.length > 0) processMinuteData(data.candles);
                } catch(e) { console.error(e); }
            };
            tick();
            updateTimer = setInterval(tick, 60000);
        }

        function processMinuteData(candlesData) {
            const cols = candlesData.columns;
            const rows = candlesData.data;
            const idx = { o: cols.indexOf('open'), c: cols.indexOf('close'), h: cols.indexOf('high'), l: cols.indexOf('low'), v: cols.indexOf('volume'), t: cols.indexOf('begin') };

            const nowUTCTs = Math.floor(Date.now() / 1000);
            const currentHourStartTs = Math.floor(nowUTCTs / 3600) * 3600;

            const minuteCandles = rows.map(r => ({
                time: Math.floor(new Date(r[idx.t].replace(' ','T')+'+03:00')/1000),
                open: +r[idx.o], high: +r[idx.h], low: +r[idx.l], close: +r[idx.c], volume: +r[idx.v]
            }));

            const currentHourMinutes = minuteCandles.filter(c => c.time >= currentHourStartTs);
            if (currentHourMinutes.length === 0) return;

            const liveHourCandle = {
                time: currentHourStartTs,
                open: currentHourMinutes[0].open,
                high: Math.max(...currentHourMinutes.map(c => c.high)),
                low: Math.min(...currentHourMinutes.map(c => c.low)),
                close: currentHourMinutes[currentHourMinutes.length - 1].close,
                volume: currentHourMinutes.reduce((sum, c) => sum + c.volume, 0)
            };

            updateChartWithLiveCandle(liveHourCandle);
        }

        function updateChartWithLiveCandle(newCandle) {
            if (!candleSeries) return;
            const lastIdx = candles.length - 1;
            if (lastIdx >= 0 && candles[lastIdx].time === newCandle.time) {
                candles[lastIdx] = newCandle;
            } else if (newCandle.time > (lastIdx >= 0 ? candles[lastIdx].time : 0)) {
                candles.push(newCandle);
            }

            updateIndicators();

            candleSeries.update(newCandle);

            if (smaLineSeries) {
                const smaData = candles.map((c, i) => indicators.sma[i] ? { time: c.time, value: indicators.sma[i] } : null).filter(Boolean);
                smaLineSeries.setData(smaData);
            }

            updateStats();
        }

        function updateIndicators() {
            indicators.sma = calcSMA(candles, 20);
            indicators.rsi = calcRSI(candles, 14);
            indicators.macd = calcMACD(candles);
            indicators.atr = calcATR(candles, 14);
            indicators.trend = analyzeTrend(candles);
        }

        function initChart() {
            if(chart) chart.remove();
            chart = LightweightCharts.createChart('chart', { layout: { backgroundColor: '#1e222d', textColor: '#d1d4dc' }, grid: { vertLines: { color: '#2a2e39' }, horzLines: { color: '#2a2e39' } }, timeScale: { timeVisible: true } });
            candleSeries = chart.addCandlestickSeries({ upColor: '#26a69a', downColor: '#ef5350', borderUpColor: '#26a69a', borderDownColor: '#ef5350' });
            candleSeries.setData(candles);
            
            smaLineSeries = chart.addLineSeries({ color: '#2962ff', lineWidth: 2, title: 'SMA 20' });
            const smaData = candles.map((c, i) => indicators.sma[i] ? { time: c.time, value: indicators.sma[i] } : null).filter(Boolean);
            smaLineSeries.setData(smaData);

            chart.timeScale().fitContent();
            window.addEventListener('resize', () => chart.applyOptions({width: $('chart').clientWidth}));
        }

        function updateStats() {
            if(!candles.length) return;
            const last = candles[candles.length-1];
            const rsiVal = indicators.rsi[indicators.rsi.length-1];
            const atrVal = indicators.atr[indicators.atr.length-1];
            const macdVal = indicators.macd.histogram[indicators.macd.histogram.length-1];
            
            $('sPrice').innerText = last.close.toFixed(2);
            $('sTrend').innerText = indicators.trend.split(" ")[0]; // First word
            $('sAtr').innerText = atrVal ? atrVal.toFixed(0) : '--';
            $('sRsi').innerText = rsiVal ? rsiVal.toFixed(1) : '--';
            
            if(macdVal) {
                $('sMacd').innerText = macdVal.toFixed(0);
                $('sMacd').style.color = macdVal > 0 ? 'var(--accent-green)' : 'var(--accent-red)';
            }
        }

        // 3. ENHANCED AI ANALYSIS
        $('analyzeBtn').onclick = async () => {
            const key = $('aiKey').value;
            if(!key) return alert("–í–≤–µ–¥–∏—Ç–µ DeepSeek API Key");

            const btn = $('analyzeBtn');
            const container = $('aiResultContainer');
            btn.disabled = true;
            btn.innerHTML = '<div class="loader"></div> –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é...';
            container.style.display = 'none';

            try {
                // News
                const newsRes = await fetch('/api/proxy', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({action:'getNews'}) });
                const newsData = await newsRes.json();
                
                // Data
                const last = candles[candles.length-1];
                const atr = indicators.atr[indicators.atr.length-1];
                const rsi = indicators.rsi[indicators.rsi.length-1];
                const sma = indicators.sma[indicators.sma.length-1];
                const macd = indicators.macd;
                const lastMacd = macd.histogram[macd.histogram.length-1];
                const prevMacd = macd.histogram[macd.histogram.length-2];

                // Enhanced Prompt
                const systemPrompt = `–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º–∏—á–µ—Å–∫–∏–π —Ç—Ä–µ–π–¥–µ—Ä. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –Ω–∞–π—Ç–∏ –≤—ã—Å–æ–∫–æ–≤–µ—Ä–æ—è—Ç–Ω—É—é —Ç–æ—á–∫—É –≤—Ö–æ–¥–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ CONFLUENCE (—Å–æ–≤–ø–∞–¥–µ–Ω–∏—è —Ñ–∞–∫—Ç–æ—Ä–æ–≤).
–ò—Å–ø–æ–ª—å–∑—É–π –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏—è:
1. –¢—Ä–µ–Ω–¥: –û–ø—Ä–µ–¥–µ–ª–∏ Higher Highs/Lower Lows.
2. RSI: >70 –ø–µ—Ä–µ–∫—É–ø–ª–µ–Ω, <30 –ø–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω. –î–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏—è?
3. MACD: –ì–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞ –º–µ–Ω—è–µ—Ç —Ü–≤–µ—Ç? –ü–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ –ª–∏–Ω–∏–π?
4. ATR: –ò—Å–ø–æ–ª—å–∑—É–π –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –°—Ç–æ–ø-–õ–æ—Å—Å–∞ (–æ–±—ã—á–Ω–æ 1.5 * ATR –æ—Ç —Ç–æ—á–∫–∏ –≤—Ö–æ–¥–∞).
5. –û–±—ä–µ–º—ã: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—Ç –ª–∏ –æ–Ω–∏ –¥–≤–∏–∂–µ–Ω–∏–µ?

–í–µ—Ä–Ω–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –°–¢–†–û–ì–û –≤ JSON:
{
  "signal": "LONG/SHORT/NEUTRAL",
  "entry_price": —á–∏—Å–ª–æ,
  "take_profit": —á–∏—Å–ª–æ,
  "stop_loss": —á–∏—Å–ª–æ,
  "confidence": 0-100,
  "summary": "–õ–æ–≥–∏–∫–∞ —Å–¥–µ–ª–∫–∏ (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)",
  "analysis": "–î–µ—Ç–∞–ª—å–Ω—ã–π —Ä–∞–∑–±–æ—Ä (—Ç—Ä–µ–Ω–¥, –æ—Å—Ü–∏–ª–ª—è—Ç–æ—Ä—ã, –æ–±—ä–µ–º—ã)",
  "risks": "–†–∏—Å–∫–∏"
}`;

                const userPrompt = `
–¢–ò–ö–ï–†: SiH6 (Si-3.26).
–¶–ï–ù–ê: ${last.close}.
–¢–†–ï–ù–î: ${indicators.trend}.
ATR (–í–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å): ${atr ? atr.toFixed(2) : 'N/A'}.
RSI(14): ${rsi ? rsi.toFixed(2) : 'N/A'}.
SMA(20): ${sma ? sma.toFixed(2) : 'N/A'}.
MACD Histogram: ${lastMacd ? lastMacd.toFixed(2) : 'N/A'} (–ü—Ä–µ–¥: ${prevMacd ? prevMacd.toFixed(2) : 'N/A'}).
–û–±—ä–µ–º: ${last.volume}.
–ù–û–í–û–°–¢–ò: ${newsData.news}

–î–∞–π TRADE SETUP —Å —Ä–∞—Å—á–µ—Ç–æ–º —Ä–∏—Å–∫–∞.
                `;

                const aiRes = await fetch('/api/proxy', {
                    method: 'POST',
                    headers: {'Content-Type':'application/json', 'Authorization': `Bearer ${key}`},
                    body: JSON.stringify({ model: 'deepseek-chat', messages: [{role: 'system', content: systemPrompt}, {role: 'user', content: userPrompt}], temperature: 0.1 })
                });
                const aiData = await aiRes.json();
                if(aiData.error) throw new Error(aiData.error.message);

                const content = aiData.choices[0].message.content;
                let parsed;
                try {
                    let cleanContent = content.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                    parsed = JSON.parse(cleanContent);
                } catch (e) { throw new Error("JSON Parse Error"); }

                renderAnalysis(parsed, container);
                drawLevels(parsed);

            } catch(e) {
                container.style.display = 'block';
                container.innerHTML = `<div style="color:var(--accent-red);">–û—à–∏–±–∫–∞: ${e.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.innerText = '–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–æ—Ä–≥–æ–≤—ã–π —Å–∏–≥–Ω–∞–ª';
            }
        };

        function renderAnalysis(data, container) {
            const signalClass = data.signal === 'LONG' ? 'signal-long' : (data.signal === 'SHORT' ? 'signal-short' : 'signal-neutral');
            container.innerHTML = `
                <div class="ai-header">
                    <h2 style="margin:0; font-size:18px;">–°–∏–≥–Ω–∞–ª: <span class="signal-badge ${signalClass}">${data.signal}</span></h2>
                    <div style="font-size:12px; color:var(--text-muted);">–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å: ${data.confidence}%</div>
                </div>
                <div class="levels-grid">
                    <div class="level-box"><div style="color:var(--text-muted); font-size:11px;">–í–•–û–î</div><div class="level-val entry-color">${data.entry_price}</div></div>
                    <div class="level-box"><div style="color:var(--text-muted); font-size:11px;">TAKE PROFIT</div><div class="level-val tp-color">${data.take_profit}</div></div>
                    <div class="level-box"><div style="color:var(--text-muted); font-size:11px;">STOP LOSS</div><div class="level-val sl-color">${data.stop_loss}</div></div>
                </div>
                <div style="background: rgba(255,255,255,0.03); padding:10px; border-radius:6px; margin-bottom:15px; font-size:13px;">
                    <b>‚ö° –õ–æ–≥–∏–∫–∞:</b> ${data.summary}
                </div>
                <div class="analysis-content">
                    <h3>üìâ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–±–æ—Ä</h3><p>${data.analysis.replace(/\n/g, '<br>')}</p>
                    <h3>‚ö†Ô∏è –†–∏—Å–∫–∏</h3><p>${data.risks.replace(/\n/g, '<br>')}</p>
                </div>
            `;
            container.style.display = 'block';
        }

        function drawLevels(data) {
            if (!candleSeries) return;
            priceLines.forEach(line => candleSeries.removePriceLine(line));
            priceLines = [];
            const createLine = (price, color, title) => {
                if(!price) return;
                const line = candleSeries.createPriceLine({ price: price, color: color, lineWidth: 2, lineStyle: 2, axisLabelVisible: true, title: title });
                priceLines.push(line);
            };
            createLine(data.entry_price, '#2962ff', 'Entry');
            createLine(data.take_profit, '#26a69a', 'TP');
            createLine(data.stop_loss, '#ef5350', 'SL');
        }
    </script>
</body>
</html>
