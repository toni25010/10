<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Si-3.26 (Real MOEX Data)</title>
    <style>
        * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: #1e1f2b; color: #e0e0e0; margin: 0; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { color: #b0b7ca; font-weight: 400; border-bottom: 1px solid #333; padding-bottom: 10px; font-size: 22px; }
        
        .api-section { background: #2a2c39; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .input-row { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
        .api-input { flex: 1; min-width: 150px; background: #1e1f2b; border: 1px solid #444; color: white; padding: 10px; border-radius: 6px; }
        button { background: #3a6ea5; border: none; color: white; padding: 10px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; }
        button:hover { background: #4d7db8; }
        button:disabled { background: #555; cursor: not-allowed; }
        
        .chart-container { background: #2a2c39; padding: 20px; border-radius: 8px; margin-bottom: 20px; position: relative; }
        #chart { width: 100%; height: 500px; }
        .watermark { position: absolute; top: 50px; left: 60px; font-size: 24px; color: rgba(255,255,255,0.05); pointer-events: none; font-weight: bold; }
        
        .status-msg { margin-top: 10px; font-size: 14px; padding: 10px; border-radius: 4px; display: none; }
        .error { background: #442326; color: #f28b82; display: block; }
        .success { background: #234427; color: #4caf50; display: block; }
        
        .indicators-panel { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .indicator-card { background: #2a2c39; padding: 15px; border-radius: 6px; border-left: 4px solid #5f9ea0; }
        .indicator-card h3 { margin: 0 0 5px 0; color: #b0b7ca; font-size: 14px; }
        .indicator-card .value { font-size: 20px; font-weight: 600; }
        
        pre { background: #1e1f2b; padding: 20px; border-radius: 6px; white-space: pre-wrap; font-family: monospace; color: #c9d1d9; }
    </style>
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
</head>
<body>
    <div class="container">
        <h1>üìà –†–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ Si-3.26 (–ö–æ–¥: SiH6) —á–µ—Ä–µ–∑ MOEX</h1>

        <div class="api-section">
            <div class="input-row">
                <input type="text" id="moexUsername" class="api-input" placeholder="–õ–æ–≥–∏–Ω MOEX (–º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º)">
                <input type="password" id="moexPassword" class="api-input" placeholder="–ü–∞—Ä–æ–ª—å MOEX (–º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º)">
            </div>
            <div class="input-row">
                <input type="date" id="fromDate" class="api-input">
                <input type="date" id="tillDate" class="api-input">
                <button id="loadDataBtn" style="flex: 0 0 auto;">üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
            </div>
            <div class="input-row">
                <input type="password" id="deepseekApiKey" class="api-input" placeholder="DeepSeek API Key (–¥–ª—è –∞–Ω–∞–ª–∏–∑–∞)">
                <button id="analyzeBtn" disabled style="flex: 0 0 auto;">üîç –ê–Ω–∞–ª–∏–∑ DeepSeek</button>
            </div>
            <div id="status" class="status-msg"></div>
        </div>

        <div class="chart-container">
            <div class="watermark">SiH6</div>
            <div id="chart"></div>
        </div>

        <div class="indicators-panel" id="indicatorsPanel">
            <div class="indicator-card"><h3>–°—Ç–∞—Ç—É—Å</h3><div class="value">–û–∂–∏–¥–∞–Ω–∏–µ...</div></div>
        </div>

        <pre id="analysisText">–ê–Ω–∞–ª–∏–∑ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å...</pre>
    </div>

    <script>
        // --- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–∞—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π) ---
        const now = new Date();
        const till = now.toISOString().split('T')[0];
        const from = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
        document.getElementById('fromDate').value = from;
        document.getElementById('tillDate').value = till;

        let rawData = [];
        let chart = null;

        document.getElementById('loadDataBtn').addEventListener('click', async () => {
            const username = document.getElementById('moexUsername').value.trim();
            const password = document.getElementById('moexPassword').value.trim();
            const fromVal = document.getElementById('fromDate').value;
            const tillVal = document.getElementById('tillDate').value;

            const statusEl = document.getElementById('status');
            statusEl.className = 'status-msg'; 
            statusEl.style.display = 'none';
            statusEl.innerText = '';

            try {
                statusEl.innerText = "‚è≥ –ó–∞–ø—Ä–æ—Å –∫ —Å–µ—Ä–≤–µ—Ä—É...";
                statusEl.className = 'status-msg success';
                statusEl.style.display = 'block';

                const response = await fetch('/api/proxy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, from: fromVal, till: tillVal })
                });

                const result = await response.json();

                if (!response.ok) throw new Error(result.error || "Server error");
                if (result.warning) throw new Error(result.warning);
                if (!result.candles || !result.candles.data.length) throw new Error("–î–∞–Ω–Ω—ã–µ –ø—É—Å—Ç—ã. –í–æ–∑–º–æ–∂–Ω–æ, –∫–æ–Ω—Ç—Ä–∞–∫—Ç –µ—â–µ –Ω–µ —Ç–æ—Ä–≥—É–µ—Ç—Å—è.");

                // --- –ü–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö MOEX ---
                const cols = result.candles.columns;
                const rows = result.candles.data;

                // –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å—ã –∫–æ–ª–æ–Ω–æ–∫
                const idx = {
                    open: cols.indexOf('open'),
                    close: cols.indexOf('close'),
                    high: cols.indexOf('high'),
                    low: cols.indexOf('low'),
                    volume: cols.indexOf('volume'),
                    begin: cols.indexOf('begin')
                };

                rawData = rows.map(r => {
                    // –ü–∞—Ä—Å–∏–º –≤—Ä–µ–º—è MSK -> UTC
                    const timeStr = r[idx.begin]; // "YYYY-MM-DD HH:MM:SS"
                    const timeObj = new Date(timeStr.replace(' ', 'T') + '+03:00');
                    
                    return {
                        time: Math.floor(timeObj.getTime() / 1000),
                        open: parseFloat(r[idx.open]),
                        high: parseFloat(r[idx.high]),
                        low: parseFloat(r[idx.low]),
                        close: parseFloat(r[idx.close]),
                        volume: parseFloat(r[idx.volume])
                    };
                }).sort((a,b) => a.time - b.time);

                drawChart();
                updatePanel();
                
                statusEl.innerText = `‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${rawData.length} —Å–≤–µ—á–µ–π.`;
                document.getElementById('analyzeBtn').disabled = false;

            } catch (e) {
                statusEl.className = 'status-msg error';
                statusEl.innerText = "‚ùå " + e.message;
                statusEl.style.display = 'block';
            }
        });

        function drawChart() {
            const container = document.getElementById('chart');
            if(chart) chart.remove();
            
            chart = LightweightCharts.createChart(container, {
                width: container.clientWidth,
                height: 500,
                layout: { backgroundColor: '#2a2c39', textColor: '#d1d4dc' },
                grid: { vertLines: { color: '#404254' }, horzLines: { color: '#404254' } },
                timeScale: { timeVisible: true }
            });

            const series = chart.addCandlestickSeries({
                upColor: '#4caf50', downColor: '#f44336',
                borderUpColor: '#4caf50', borderDownColor: '#f44336',
                wickUpColor: '#4caf50', wickDownColor: '#f44336'
            });
            
            series.setData(rawData);
            chart.timeScale().fitContent();
            
            window.addEventListener('resize', () => chart.applyOptions({ width: container.clientWidth }));
        }

        function updatePanel() {
            if(rawData.length < 2) return;
            const last = rawData[rawData.length-1];
            const prev = rawData[rawData.length-2];
            const diff = last.close - prev.close;
            
            document.getElementById('indicatorsPanel').innerHTML = `
                <div class="indicator-card">
                    <h3>–ü–æ—Å–ª–µ–¥–Ω—è—è —Ü–µ–Ω–∞</h3>
                    <div class="value">${last.close.toFixed(2)}</div>
                </div>
                <div class="indicator-card">
                    <h3>–ò–∑–º–µ–Ω–µ–Ω–∏–µ</h3>
                    <div class="value" style="color: ${diff >= 0 ? '#4caf50' : '#f44336'}">${diff > 0 ? '+' : ''}${diff.toFixed(2)}</div>
                </div>
                <div class="indicator-card">
                    <h3>–í—Ä–µ–º—è (UTC)</h3>
                    <div class="value">${new Date(last.time*1000).toLocaleTimeString()}</div>
                </div>
            `;
        }

        // --- DeepSeek –ê–Ω–∞–ª–∏–∑ ---
        document.getElementById('analyzeBtn').addEventListener('click', async () => {
            const key = document.getElementById('deepseekApiKey').value;
            if(!key) return alert("–í–≤–µ–¥–∏—Ç–µ API Key DeepSeek");
            if(rawData.length === 0) return alert("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö");

            const btn = document.getElementById('analyzeBtn');
            const out = document.getElementById('analysisText');
            btn.disabled = true;
            btn.innerText = "–î—É–º–∞—é...";
            out.innerText = "–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Ä—ã–Ω–æ—á–Ω—É—é —Å–∏—Ç—É–∞—Ü–∏—é...";

            const csv = rawData.slice(-30).map(d => `${d.time},${d.close}`).join('\n');

            try {
                const res = await fetch('/api/proxy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: [{
                            role: 'user', 
                            content: `–§—å—é—á–µ—Ä—Å Si (SiH6). –ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–∞–Ω–Ω—ã–µ (Time, Close):\n${csv}\n–î–∞–π –ø—Ä–æ–≥–Ω–æ–∑.`
                        }]
                    })
                });
                const data = await res.json();
                if(data.error) throw new Error(data.error.message);
                out.innerText = data.choices[0].message.content;
            } catch(e) {
                out.innerText = "–û—à–∏–±–∫–∞: " + e.message;
            } finally {
                btn.disabled = false;
                btn.innerText = "üîç –ê–Ω–∞–ª–∏–∑ DeepSeek";
            }
        });
    </script>
</body>
</html>
