<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Si-3.26 Live Auto-Update</title>
    <style>
        * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: #1e1f2b; color: #e0e0e0; margin: 0; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { color: #b0b7ca; border-bottom: 1px solid #333; padding-bottom: 10px; display: flex; justify-content: space-between; }
        .live-badge { background: #f44336; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; animation: blink 2s infinite; }
        @keyframes blink { 50% { opacity: 0.7; } }

        .panel { background: #2a2c39; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .row { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
        input { flex: 1; min-width: 140px; background: #1e1f2b; border: 1px solid #444; color: white; padding: 10px; border-radius: 6px; }
        
        button { background: #3a6ea5; border: none; color: white; padding: 10px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; }
        button:hover { background: #4d7db8; }
        button:disabled { background: #555; cursor: not-allowed; }
        .btn-green { background: #2e7d32; }
        .btn-stop { background: #c62828; }

        #chart { width: 100%; height: 450px; background: #2a2c39; border-radius: 8px; }
        
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .card { background: #2a2c39; padding: 15px; border-radius: 6px; border-left: 4px solid #5f9ea0; }
        .card h3 { margin: 0 0 5px 0; color: #b0b7ca; font-size: 14px; }
        .card .val { font-size: 20px; font-weight: 600; }
        
        pre { background: #2a2c39; padding: 15px; border-radius: 6px; white-space: pre-wrap; font-family: monospace; }
        
        .status { font-size: 13px; padding: 8px; border-radius: 4px; margin-top: 10px; display: none; }
        .err { background: #442326; color: #f28b82; }
        .ok { background: #234427; color: #4caf50; }
    </style>
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
</head>
<body>
    <div class="container">
        <h1>
            <span>üìà Si-3.26 Live Chart</span>
            <span id="liveBadge" style="display:none" class="live-badge">LIVE</span>
        </h1>

        <div class="panel">
            <div class="row">
                <input type="text" id="user" placeholder="–õ–æ–≥–∏–Ω MOEX">
                <input type="password" id="pass" placeholder="–ü–∞—Ä–æ–ª—å MOEX">
            </div>
            <div class="row">
                <input type="date" id="from">
                <input type="date" id="to">
                <button id="loadBtn" style="flex: 0 0 150px;">üì• –ü–æ–ª—É—á–∏—Ç—å –∫–æ—Ç–∏—Ä–æ–≤–∫–∏</button>
                <button id="stopBtn" class="btn-stop" style="flex: 0 0 100px; display:none;">‚èπ –°—Ç–æ–ø</button>
            </div>
            
            <div style="border-top:1px solid #444; margin:15px 0; padding-top:15px;">
                <div class="row">
                    <input type="password" id="aiKey" placeholder="DeepSeek API Key">
                </div>
                <button id="analyzeBtn" disabled class="btn-green" style="width:100%;">üß† –ê–Ω–∞–ª–∏–∑ (–ê–≤—Ç–æ-–Ω–æ–≤–æ—Å—Ç–∏ + –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã)</button>
            </div>
            
            <div id="status" class="status"></div>
        </div>

        <div class="stats" id="stats">
            <div class="card"><h3>–†–µ–∂–∏–º</h3><div class="val">–û–∂–∏–¥–∞–Ω–∏–µ</div></div>
        </div>

        <div id="chart"></div>

        <pre id="out">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å...</pre>
    </div>

    <script>
        // --- –î–∞—Ç—ã ---
        document.getElementById('to').value = new Date().toISOString().split('T')[0];
        document.getElementById('from').value = new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

        let chart = null;
        let candleSeries = null;
        let candles = [];
        let updateTimer = null;

        // --- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã ---
        const calcSMA = (d, p) => d.map((v,i,a) => i<p-1?null:a.slice(i-p+1,i+1).reduce((s,x)=>s+x.close,0)/p);
        const calcRSI = (d, p=14) => {
            let rsi=[], g=0, l=0;
            for(let i=1; i<=p; i++){ let df=d[i].close-d[i-1].close; df>0?g+=df:l-=df; }
            let ag=g/p, al=l/p;
            for(let i=0; i<d.length; i++){
                if(i<p){rsi.push(null);continue;}
                if(i>p){let df=d[i].close-d[i-1].close; ag=(ag*(p-1)+(df>0?df:0))/p; al=(al*(p-1)+(df<0?-df:0))/p;}
                rsi.push(al==0?100:100-100/(1+ag/al));
            }
            return rsi;
        };

        // --- 1. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ò –ó–ê–ü–£–°–ö –ê–í–¢–û–û–ë–ù–û–í–õ–ï–ù–ò–Ø ---
        document.getElementById('loadBtn').onclick = async () => {
            const btn = document.getElementById('loadBtn');
            const stopBtn = document.getElementById('stopBtn');
            const status = document.getElementById('status');
            
            status.style.display='block'; status.className='status ok'; status.innerText='‚è≥ –ü–µ—Ä–≤–∏—á–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...';

            try {
                // –ê. –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é (–∏–Ω—Ç–µ—Ä–≤–∞–ª 60 –º–∏–Ω)
                const res = await fetch('/api/proxy', {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({
                        username: document.getElementById('user').value,
                        password: document.getElementById('pass').value,
                        from: document.getElementById('from').value,
                        till: document.getElementById('to').value,
                        interval: 60
                    })
                });
                const data = await res.json();
                if (!res.ok || data.warning) throw new Error(data.error || data.warning || "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö");

                // –ü–∞—Ä—Å–∏–Ω–≥
                const cols = data.candles.columns;
                const idx = { o: cols.indexOf('open'), c: cols.indexOf('close'), h: cols.indexOf('high'), l: cols.indexOf('low'), v: cols.indexOf('volume'), t: cols.indexOf('begin') };
                
                candles = data.candles.data.map(r => ({
                    time: Math.floor(new Date(r[idx.t].replace(' ','T')+'+03:00')/1000),
                    open: +r[idx.o], high: +r[idx.h], low: +r[idx.l], close: +r[idx.c], volume: +r[idx.v]
                })).sort((a,b)=>a.time-b.time);

                drawChart();
                updateStats();
                
                // –ë. –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
                btn.style.display = 'none';
                stopBtn.style.display = 'block';
                document.getElementById('liveBadge').style.display = 'inline-block';
                document.getElementById('analyzeBtn').disabled = false;
                status.innerText = '‚úÖ –ò—Å—Ç–æ—Ä–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É...';

                startLiveFeed();

            } catch(e) {
                status.className='status err';
                status.innerText = '‚ùå –û—à–∏–±–∫–∞: ' + e.message;
            }
        };

        // –ö–Ω–æ–ø–∫–∞ –°–¢–û–ü
        document.getElementById('stopBtn').onclick = () => {
            clearInterval(updateTimer);
            document.getElementById('loadBtn').style.display = 'block';
            document.getElementById('stopBtn').style.display = 'none';
            document.getElementById('liveBadge').style.display = 'none';
            document.getElementById('status').innerText = '‚è∏ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ.';
        };

        // --- 2. –§–£–ù–ö–¶–ò–Ø –ê–í–¢–û–û–ë–ù–û–í–õ–ï–ù–ò–Ø (–ó–ê–ü–£–°–ö –í 16 –ú–ò–ù–£–¢ –ò –ö–ê–ñ–î–£–Æ –ú–ò–ù–£–¢–£) ---
        function startLiveFeed() {
            // –§—É–Ω–∫—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞ –∞–∫—Ç—É–∞–ª—å–Ω–æ–π —Å–≤–µ—á–∏
            const tick = async () => {
                console.log("Update tick...");
                try {
                    // –ë–µ—Ä–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å (interval=60, –Ω–æ –∑–∞–ø—Ä–æ—Å till=now)
                    // MOEX –≤–µ—Ä–Ω–µ—Ç –ø–æ—Å–ª–µ–¥–Ω—é—é —Å–≤–µ—á—É (—Ç–µ–∫—É—â–µ–≥–æ —á–∞—Å–∞), –∫–æ—Ç–æ—Ä–∞—è –º–µ–Ω—è–µ—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
                    const now = new Date();
                    const hourAgo = new Date(now.getTime() - 2 * 60 * 60 * 1000); // -2 —á–∞—Å–∞ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
                    
                    const res = await fetch('/api/proxy', {
                        method: 'POST',
                        headers: {'Content-Type':'application/json'},
                        body: JSON.stringify({
                            username: document.getElementById('user').value,
                            password: document.getElementById('pass').value,
                            from: hourAgo.toISOString().split('T')[0], // –î–∞—Ç–∞
                            till: now.toISOString().split('T')[0],
                            interval: 60
                        })
                    });
                    const data = await res.json();
                    if (data.candles && data.candles.data.length > 0) {
                        updateLastCandle(data.candles);
                    }
                } catch (e) {
                    console.error("Tick error", e);
                }
            };

            // –õ–æ–≥–∏–∫–∞ "–≤ 16 –º–∏–Ω—É—Ç—É –∫–∞–∂–¥–æ–≥–æ —á–∞—Å–∞" + –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
            // –ï—Å–ª–∏ –Ω—É–∂–Ω–æ —Å—Ç—Ä–æ–≥–æ –≤ 16-—é –º–∏–Ω—É—Ç—É, –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —Ç–∞–π–º–µ—Ä.
            // –ù–æ –¥–ª—è –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ –≥—Ä–∞—Ñ–∏–∫–∞ –ª—É—á—à–µ –æ–±–Ω–æ–≤–ª—è—Ç—å –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É.
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º —Å—Ä–∞–∑—É
            tick(); 
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª —Ä–∞–∑ –≤ 60 —Å–µ–∫—É–Ω–¥
            updateTimer = setInterval(tick, 60000);
        }

        function updateLastCandle(candlesData) {
            if (!candleSeries) return;

            const cols = candlesData.columns;
            const rows = candlesData.data;
            const idx = { o: cols.indexOf('open'), c: cols.indexOf('close'), h: cols.indexOf('high'), l: cols.indexOf('low'), v: cols.indexOf('volume'), t: cols.indexOf('begin') };

            // –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é —Å–≤–µ—á—É –∏–∑ –æ—Ç–≤–µ—Ç–∞ (—ç—Ç–æ —Ç–µ–∫—É—â–∏–π —á–∞—Å)
            const lastRow = rows[rows.length - 1];
            const lastTime = Math.floor(new Date(lastRow[idx.t].replace(' ','T')+'+03:00')/1000);
            
            const newCandle = {
                time: lastTime,
                open: +lastRow[idx.o],
                high: +lastRow[idx.h],
                low: +lastRow[idx.l],
                close: +lastRow[idx.c],
                volume: +lastRow[idx.v]
            };

            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–ª–∏ –¥–æ–±–∞–≤–ª—è–µ–º —Å–≤–µ—á—É –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ
            // Lightweight-Charts —Å–∞–º —Ä–∞–∑–±–µ—Ä–µ—Ç—Å—è: –µ—Å–ª–∏ –≤—Ä–µ–º—è —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –ø–æ—Å–ª–µ–¥–Ω–µ–π, –æ–Ω –æ–±–Ω–æ–≤–∏—Ç –µ—ë
            candleSeries.update(newCandle);

            // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –º–∞—Å—Å–∏–≤ (–¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏)
            if (candles.length > 0 && candles[candles.length-1].time === lastTime) {
                candles[candles.length-1] = newCandle;
            } else if (lastTime > (candles.length > 0 ? candles[candles.length-1].time : 0)) {
                candles.push(newCandle);
            }

            updateStats();
        }

        function drawChart() {
            const container = document.getElementById('chart');
            if(chart) chart.remove();
            chart = LightweightCharts.createChart(container, { layout: { backgroundColor: '#2a2c39', textColor: '#d1d4dc' }, timeScale: { timeVisible: true } });
            candleSeries = chart.addCandlestickSeries({ upColor: '#4caf50', downColor: '#f44336', borderUpColor: '#4caf50', borderDownColor: '#f44336' });
            candleSeries.setData(candles);
            chart.timeScale().fitContent();
            window.addEventListener('resize', () => chart.applyOptions({width: container.clientWidth}));
        }

        function updateStats() {
            if(!candles.length) return;
            const last = candles[candles.length-1];
            const prev = candles.length > 1 ? candles[candles.length-2] : last;
            const diff = last.close - prev.close;
            
            document.getElementById('stats').innerHTML = `
                <div class="card"><h3>–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞ (Live)</h3><div class="val" style="color:${diff>=0?'#4caf50':'#f44336'}">${last.close.toFixed(2)}</div></div>
                <div class="card"><h3>High (–¢–µ–∫—É—â–∏–π —á–∞—Å)</h3><div class="val">${last.high.toFixed(2)}</div></div>
                <div class="card"><h3>Low (–¢–µ–∫—É—â–∏–π —á–∞—Å)</h3><div class="val">${last.low.toFixed(2)}</div></div>
                <div class="card"><h3>–í—Ä–µ–º—è</h3><div class="val">${new Date(last.time*1000).toLocaleTimeString('ru-RU')}</div></div>
            `;
        }

        // --- –ê–ù–ê–õ–ò–ó DEEPSEEK ---
        document.getElementById('analyzeBtn').onclick = async () => {
            const key = document.getElementById('aiKey').value;
            if(!key) return alert('–í–≤–µ–¥–∏—Ç–µ DeepSeek API Key');
            if(candles.length < 20) return alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö');

            const btn = document.getElementById('analyzeBtn');
            const out = document.getElementById('out');
            const status = document.getElementById('status');
            
            btn.disabled = true; btn.innerText = '‚è≥ –ü–æ–ª—É—á–∞—é –Ω–æ–≤–æ—Å—Ç–∏...';
            status.innerText = '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π...';

            try {
                // –ù–æ–≤–æ—Å—Ç–∏
                const newsRes = await fetch('/api/proxy', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({action:'getNews'}) });
                const newsData = await newsRes.json();
                const newsText = newsData.news;
                
                btn.innerText = '‚è≥ –ê–Ω–∞–ª–∏–∑ DeepSeek...';
                status.innerText = '‚è≥ –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Ä—ã–Ω–æ–∫...';

                // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
                const sma = calcSMA(candles, 20);
                const rsi = calcRSI(candles, 14);
                const last = candles[candles.length-1];
                
                let csv = "Time,O,H,L,C,V,SMA,RSI\n";
                candles.slice(-48).forEach((c,i) => {
                    let idx = candles.length - 48 + i;
                    if(idx < 0) return;
                    csv += `${new Date(c.time*1000).toISOString().slice(11,16)},${c.open},${c.high},${c.low},${c.close},${c.volume},${sma[idx]?.toFixed(2)||''},${rsi[idx]?.toFixed(2)||''}\n`;
                });

                const prompt = {
                    model: 'deepseek-chat',
                    messages: [
                        {role:'system', content: '–¢—ã –ø—Ä–æ—Ñ–∏-—Ç—Ä–µ–π–¥–µ—Ä. –î–∞–π –ø—Ä–æ–≥–Ω–æ–∑ Si (USD/RUB) –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ—Ö–∞–Ω–∞–ª–∏–∑–∞ (SMA, RSI) –∏ –Ω–æ–≤–æ—Å—Ç–µ–π.'},
                        {role:'user', content: `–¶–ï–ù–ê: ${last.close}. –ù–û–í–û–°–¢–ò:\n${newsText}\n\n–î–ê–ù–ù–´–ï (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 48 —á–∞—Å–æ–≤):\n${csv}`}
                    ]
                };

                const aiRes = await fetch('/api/proxy', { 
                    method:'POST', 
                    headers: {'Content-Type':'application/json', 'Authorization': `Bearer ${key}`},
                    body: JSON.stringify(prompt)
                });
                const aiData = await aiRes.json();
                if(aiData.error) throw new Error(aiData.error.message);

                out.innerText = aiData.choices[0].message.content;
                status.innerText = '‚úÖ –ê–Ω–∞–ª–∏–∑ –≥–æ—Ç–æ–≤.';

            } catch(e) {
                out.innerText = "–û—à–∏–±–∫–∞: " + e.message;
                status.className='status err';
            } finally {
                btn.disabled = false; 
                btn.innerText = 'üß† –ê–Ω–∞–ª–∏–∑ (–ê–≤—Ç–æ-–Ω–æ–≤–æ—Å—Ç–∏ + –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã)';
            }
        };
    </script>
</body>
</html>
