<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Si-3.26 Auto-Analysis</title>
    <style>
        * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: #1e1f2b; color: #e0e0e0; margin: 0; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { color: #b0b7ca; border-bottom: 1px solid #333; padding-bottom: 10px; }
        
        .panel { background: #2a2c39; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .row { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
        input, select { flex: 1; min-width: 140px; background: #1e1f2b; border: 1px solid #444; color: white; padding: 10px; border-radius: 6px; }
        
        button { background: #3a6ea5; border: none; color: white; padding: 10px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        button:hover { background: #4d7db8; }
        button:disabled { background: #555; cursor: not-allowed; }
        .btn-green { background: #2e7d32; }
        .btn-green:hover { background: #388e3c; }

        #chart { width: 100%; height: 400px; background: #2a2c39; border-radius: 8px; }
        
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .card { background: #2a2c39; padding: 15px; border-radius: 6px; border-left: 4px solid #5f9ea0; }
        .card h3 { margin: 0 0 5px 0; color: #b0b7ca; font-size: 14px; }
        .card .val { font-size: 20px; font-weight: 600; }
        
        pre { background: #2a2c39; padding: 15px; border-radius: 6px; white-space: pre-wrap; font-family: monospace; line-height: 1.5; }
        
        .status { font-size: 13px; padding: 8px; border-radius: 4px; margin-top: 10px; display: none; }
        .err { background: #442326; color: #f28b82; }
        .ok { background: #234427; color: #4caf50; }
        
        .news-box { background: #1e1f2b; padding: 10px; border-radius: 4px; margin-top: 10px; font-size: 12px; color: #aaa; border: 1px dashed #444; }
    </style>
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
</head>
<body>
    <div class="container">
        <h1>üìà Si-3.26 (SiH6) ‚Äî –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π + –§—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑</h1>

        <!-- –ü–∞–Ω–µ–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
        <div class="panel">
            <div class="row">
                <input type="text" id="user" placeholder="–õ–æ–≥–∏–Ω MOEX (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
                <input type="password" id="pass" placeholder="–ü–∞—Ä–æ–ª—å MOEX">
            </div>
            <div class="row">
                <input type="date" id="from">
                <input type="date" id="to">
                <button id="loadBtn">üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫</button>
            </div>
            
            <div style="border-top:1px solid #444; margin:15px 0; padding-top:15px;">
                <div class="row">
                    <input type="password" id="aiKey" placeholder="DeepSeek API Key">
                </div>
                <button id="analyzeBtn" disabled class="btn-green" style="width:100%;">üß† –°–¥–µ–ª–∞—Ç—å –ø—Ä–æ–≥–Ω–æ–∑ (–ê–≤—Ç–æ-–Ω–æ–≤–æ—Å—Ç–∏ + –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã)</button>
            </div>
            
            <div id="status" class="status"></div>
            <div id="newsBox" class="news-box" style="display:none;">
                <b>üì∞ –ê–≤—Ç–æ–Ω–æ–≤–æ—Å—Ç–∏ (Google RSS):</b><br>
                <span id="newsText"></span>
            </div>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="stats" id="stats">
            <div class="card"><h3>–°—Ç–∞—Ç—É—Å</h3><div class="val">–û–∂–∏–¥–∞–Ω–∏–µ...</div></div>
        </div>

        <!-- –ì—Ä–∞—Ñ–∏–∫ -->
        <div id="chart"></div>

        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç -->
        <pre id="out">–ê–Ω–∞–ª–∏–∑ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å...</pre>
    </div>

    <script>
        // --- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–∞—Ç (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π) ---
        document.getElementById('to').value = new Date().toISOString().split('T')[0];
        document.getElementById('from').value = new Date(Date.now() - 7*24*60*60*1000).toISOString().split('T')[0];

        let chart = null;
        let candles = [];

        // --- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã ---
        const calcSMA = (d, p) => d.map((v,i,a) => i<p-1?null:a.slice(i-p+1,i+1).reduce((s,x)=>s+x.close,0)/p);
        const calcRSI = (d, p=14) => {
            let rsi=[], g=0, l=0;
            for(let i=1; i<=p; i++){ let df=d[i].close-d[i-1].close; df>0?g+=df:l-=df; }
            let ag=g/p, al=l/p;
            for(let i=0; i<d.length; i++){
                if(i<p){rsi.push(null);continue;}
                if(i>p){let df=d[i].close-d[i-1].close; ag=(ag*(p-1)+(df>0?df:0))/p; al=(al*(p-1)+(df<0?-df:0))/p;}
                rsi.push(al==0?100:100-100/(1+ag/al));
            }
            return rsi;
        };

        // --- 1. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö MOEX ---
        document.getElementById('loadBtn').onclick = async () => {
            const btn = document.getElementById('loadBtn');
            const status = document.getElementById('status');
            status.style.display='block'; status.className='status ok'; status.innerText='‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å MOEX...';
            
            try {
                const res = await fetch('/api/proxy', {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({
                        username: document.getElementById('user').value,
                        password: document.getElementById('pass').value,
                        from: document.getElementById('from').value,
                        till: document.getElementById('to').value
                    })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error);
                if (data.warning) throw new Error(data.warning);
                if (!data.candles) throw new Error("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö");

                // –ü–∞—Ä—Å–∏–Ω–≥
                const cols = data.candles.columns;
                const idx = { o: cols.indexOf('open'), c: cols.indexOf('close'), h: cols.indexOf('high'), l: cols.indexOf('low'), v: cols.indexOf('volume'), t: cols.indexOf('begin') };
                
                candles = data.candles.data.map(r => ({
                    time: Math.floor(new Date(r[idx.t].replace(' ','T')+'+03:00')/1000),
                    open: +r[idx.o], high: +r[idx.h], low: +r[idx.l], close: +r[idx.c], volume: +r[idx.v]
                })).sort((a,b)=>a.time-b.time);

                drawChart();
                updateStats();
                
                status.innerText = '‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.';
                document.getElementById('analyzeBtn').disabled = false;
            } catch(e) {
                status.className='status err';
                status.innerText = '‚ùå –û—à–∏–±–∫–∞: ' + e.message;
            }
        };

        function drawChart() {
            const container = document.getElementById('chart');
            if(chart) chart.remove();
            chart = LightweightCharts.createChart(container, { layout: { backgroundColor: '#2a2c39', textColor: '#d1d4dc' }, timeScale: { timeVisible: true } });
            const series = chart.addCandlestickSeries({ upColor: '#4caf50', downColor: '#f44336', borderUpColor: '#4caf50', borderDownColor: '#f44336' });
            series.setData(candles);
            chart.timeScale().fitContent();
            window.addEventListener('resize', () => chart.applyOptions({width: container.clientWidth}));
        }

        function updateStats() {
            const last = candles[candles.length-1];
            document.getElementById('stats').innerHTML = `
                <div class="card"><h3>–¶–µ–Ω–∞</h3><div class="val">${last.close.toFixed(2)}</div></div>
                <div class="card"><h3>–û–±—ä–µ–º</h3><div class="val">${last.volume}</div></div>
                <div class="card"><h3>–°–≤–µ—á–µ–π</h3><div class="val">${candles.length}</div></div>
            `;
        }

        // --- 2. –ê–Ω–∞–ª–∏–∑ (–ù–æ–≤–æ—Å—Ç–∏ + AI) ---
        document.getElementById('analyzeBtn').onclick = async () => {
            const key = document.getElementById('aiKey').value;
            if(!key) return alert('–í–≤–µ–¥–∏—Ç–µ DeepSeek API Key');
            if(!candles.length) return alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö');

            const btn = document.getElementById('analyzeBtn');
            const status = document.getElementById('status');
            const out = document.getElementById('out');
            const newsDiv = document.getElementById('newsBox');
            
            btn.disabled = true; btn.innerText = '‚è≥ –ü–æ–ª—É—á–∞—é –Ω–æ–≤–æ—Å—Ç–∏...';
            status.style.display='block'; status.className='status ok'; status.innerText='‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π...';

            try {
                // –ê. –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π
                const newsRes = await fetch('/api/proxy', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({action:'getNews'}) });
                const newsData = await newsRes.json();
                const newsText = newsData.news;
                
                document.getElementById('newsText').innerText = newsText;
                newsDiv.style.display = 'block';
                
                status.innerText = '‚è≥ –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é...';
                btn.innerText = '‚è≥ –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é...';

                // –ë. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
                const sma = calcSMA(candles, 20);
                const rsi = calcRSI(candles, 14);
                const last = candles[candles.length-1];
                
                // –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 48 —Å–≤–µ—á–µ–π –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤
                const window = candles.slice(-48);
                let csv = "Time,Open,High,Low,Close,Vol,SMA20,RSI14\n";
                window.forEach((c,i) => {
                    let idx = candles.length - window.length + i;
                    csv += `${new Date(c.time*1000).toISOString().slice(0,16)},${c.open},${c.high},${c.low},${c.close},${c.volume},${sma[idx]?.toFixed(2)||''},${rsi[idx]?.toFixed(2)||''}\n`;
                });

                // –í. –ó–∞–ø—Ä–æ—Å –∫ DeepSeek
                const prompt = {
                    model: 'deepseek-chat',
                    messages: [
                        {role:'system', content: '–¢—ã –ø—Ä–æ—Ñ–∏-—Ç—Ä–µ–π–¥–µ—Ä –Ω–∞ MOEX. –î–∞–π –∫—Ä–∞—Ç–∫–∏–π –ø—Ä–æ–≥–Ω–æ–∑ Si –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ—Ö. –¥–∞–Ω–Ω—ã—Ö (SMA, RSI, –û–±—ä–µ–º—ã) –∏ –Ω–æ–≤–æ—Å—Ç–µ–π.'},
                        {role:'user', content: `–¢–ò–ö–ï–†: SiH6.\n–¶–ï–ù–ê: ${last.close}.\n–ù–û–í–û–°–¢–ò:\n${newsText}\n\n–î–ê–ù–ù–´–ï (CSV):\n${csv}\n\n–î–∞–π –≤—ã–≤–æ–¥ –∏ –ø—Ä–æ–≥–Ω–æ–∑.`}
                    ]
                };

                const aiRes = await fetch('/api/proxy', { 
                    method:'POST', 
                    headers: {'Content-Type':'application/json', 'Authorization': `Bearer ${key}`},
                    body: JSON.stringify(prompt)
                });
                const aiData = await aiRes.json();
                if(aiData.error) throw new Error(aiData.error.message);

                out.innerText = aiData.choices[0].message.content;
                status.innerText = '‚úÖ –ì–æ—Ç–æ–≤–æ.';

            } catch(e) {
                out.innerText = "–û—à–∏–±–∫–∞: " + e.message;
                status.className='status err';
                status.innerText = '‚ùå –û—à–∏–±–∫–∞';
            } finally {
                btn.disabled = false; 
                btn.innerText = 'üß† –°–¥–µ–ª–∞—Ç—å –ø—Ä–æ–≥–Ω–æ–∑ (–ê–≤—Ç–æ-–Ω–æ–≤–æ—Å—Ç–∏ + –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã)';
            }
        };
    </script>
</body>
</html>
